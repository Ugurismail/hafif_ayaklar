{% extends 'core/base.html' %}
{% load static %}

{% block title %}DJ Paneli{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/radio.css' %}?v={{ STATIC_ASSET_VERSION }}">
{% endblock %}

{% block content %}
<div class="radio-page">
    <div class="radio-shell">
        <header class="radio-hero radio-fade">
            <div>
                <span class="hero-eyebrow">DJ Kontrol Paneli</span>
                <h1 class="hero-title">Yayını yönet, sesi düzenle, takvimi planla.</h1>
                <p class="hero-subtitle">
                    Programlarını tek yerden gör, canlı yayını başlat ya da bitir. Dinleyici akışını takip et.
                </p>
                <div class="hero-actions">
                    <a href="{% url 'radio_home' %}" class="btn btn-outline-theme-secondary">
                        <i class="bi bi-arrow-left"></i> Radyo Ana Sayfa
                    </a>
                    <a href="{% url 'create_program' %}" class="btn btn-theme-primary">
                        <i class="bi bi-plus-circle"></i> Yeni Program
                    </a>
                </div>
            </div>
        </header>

        {% if live_programs %}
            <section class="radio-section">
                <div class="section-head">
                    <h2>Canlı Yayınlarım</h2>
                    <span class="section-chip">Live</span>
                </div>
                <div class="radio-grid">
                    {% for program in live_programs %}
                        <article class="radio-card live" style="--delay: {{ forloop.counter }};">
                            <div class="live-chip"><i class="bi bi-broadcast"></i> CANLI</div>
                            <h3>{{ program.title }}</h3>
                            {% if program.description %}
                                <p>{{ program.description|truncatewords:26 }}</p>
                            {% endif %}
                            <div class="meta">
                                <span><i class="bi bi-clock"></i> {{ program.start_time|date:"H:i" }} - {{ program.end_time|date:"H:i" }}</span>
                                <span><i class="bi bi-people"></i> {{ program.listener_count }} dinleyici</span>
                            </div>
                            <div class="action-row">
                                <button class="btn btn-theme-secondary stop-broadcast-btn" data-program-id="{{ program.id }}">
                                    <i class="bi bi-stop-circle"></i> Yayını Bitir
                                </button>
                                <a href="{% url 'program_detail' program.id %}" class="btn btn-outline-theme-primary btn-sm">
                                    <i class="bi bi-eye"></i> Görüntüle
                                </a>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            </section>
        {% endif %}

        {% if ready_programs %}
            <section class="radio-section">
                <div class="section-head">
                    <h2>Başlamaya Hazır</h2>
                    <span class="section-chip">Ready</span>
                </div>
                <div class="radio-grid">
                    {% for program in ready_programs %}
                        <article class="radio-card" style="--delay: {{ forloop.counter }};">
                            <div class="live-chip"><i class="bi bi-play-circle"></i> HAZIR</div>
                            <h3>{{ program.title }}</h3>
                            {% if program.description %}
                                <p>{{ program.description|truncatewords:24 }}</p>
                            {% endif %}
                            <div class="meta">
                                <span><i class="bi bi-clock"></i> {{ program.start_time|date:"H:i" }} - {{ program.end_time|date:"H:i" }}</span>
                            </div>
                            <div class="action-row">
                                <button class="btn btn-theme-primary start-broadcast-btn" data-program-id="{{ program.id }}">
                                    <i class="bi bi-broadcast"></i> Yayını Başlat
                                </button>
                                <a href="{% url 'program_detail' program.id %}" class="btn btn-outline-theme-primary btn-sm">
                                    <i class="bi bi-eye"></i> Görüntüle
                                </a>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            </section>
        {% endif %}

        <section class="radio-section">
            <div class="section-head">
                <h2>Yaklaşan Programlarım</h2>
                <span class="section-chip">Next</span>
            </div>
            {% if upcoming_programs %}
                <div class="radio-list">
                    {% for program in upcoming_programs %}
                        <article class="radio-row">
                            <strong>{{ program.title }}</strong>
                            <div class="row-meta">
                                <span><i class="bi bi-calendar"></i> {{ program.start_time|date:"d F Y, H:i" }} - {{ program.end_time|date:"H:i" }}</span>
                            </div>
                            {% if program.description %}
                                <p class="mb-0">{{ program.description|truncatewords:30 }}</p>
                            {% endif %}
                            <div class="action-row">
                                {% if program.is_active_time and not program.is_live %}
                                    <button class="btn btn-theme-primary btn-sm start-broadcast-btn" data-program-id="{{ program.id }}">
                                        <i class="bi bi-play-circle"></i> Başlat
                                    </button>
                                {% endif %}
                                <a href="{% url 'edit_program' program.id %}" class="btn btn-outline-theme-primary btn-sm">
                                    <i class="bi bi-pencil"></i> Düzenle
                                </a>
                                <a href="{% url 'delete_program' program.id %}" class="btn btn-outline-theme-secondary btn-sm">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="radio-empty">Yaklaşan programın yok.</div>
            {% endif %}
        </section>

        {% if past_programs %}
            <section class="radio-section">
                <div class="section-head">
                    <h2>Geçmiş Programlarım</h2>
                    <span class="section-chip">Arşiv</span>
                </div>
                <div class="radio-list">
                    {% for program in past_programs %}
                        <article class="radio-row">
                            <strong>{{ program.title }}</strong>
                            <div class="row-meta">
                                <span><i class="bi bi-calendar"></i> {{ program.start_time|date:"d F Y, H:i" }}</span>
                                <span><i class="bi bi-people"></i> En çok {{ program.max_listeners }} dinleyici</span>
                            </div>
                            <div class="action-row">
                                <a href="{% url 'program_detail' program.id %}" class="btn btn-outline-theme-primary btn-sm">
                                    <i class="bi bi-eye"></i> Görüntüle
                                </a>
                                <a href="{% url 'delete_program' program.id %}" class="btn btn-outline-theme-secondary btn-sm">
                                    <i class="bi bi-trash"></i> Sil
                                </a>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            </section>
        {% endif %}
    </div>
</div>

<script>
// getCookie() and showToast() are now loaded globally from base.js

document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = getCookie('csrftoken');

    // Yayın başlatma
    document.querySelectorAll('.start-broadcast-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const programId = this.getAttribute('data-program-id');
            if (confirm('Yayını başlatmak istediğinize emin misiniz?')) {
                fetch(`/radio/dj/start/${programId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast(data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Bir hata oluştu', 'error');
                });
            }
        });
    });

    // Yayın bitirme
    document.querySelectorAll('.stop-broadcast-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const programId = this.getAttribute('data-program-id');
            if (confirm('Yayını bitirmek istediğinize emin misiniz?')) {
                fetch(`/radio/dj/stop/${programId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast(data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Bir hata oluştu', 'error');
                });
            }
        });
    });
});
</script>
{% endblock %}
