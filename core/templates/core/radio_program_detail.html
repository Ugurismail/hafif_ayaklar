{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ program.title }} - Radyo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/radio.css' %}?v={{ STATIC_ASSET_VERSION }}">
{% endblock %}

{% block content %}
<div class="radio-page">
    <div class="radio-shell">
        <header class="radio-header">
            <div class="radio-header__copy">
                <span class="radio-kicker">Radyo Programı</span>
                <h1 class="radio-title">{{ program.title }}</h1>
                <p class="radio-subtitle">
                    {% if program.description %}
                        {{ program.description|truncatewords:28 }}
                    {% else %}
                        Program notları burada görünür. Canlı yayına katılabilir ya da sonraki programa göz atabilirsin.
                    {% endif %}
                </p>
                <div class="radio-tags">
                    {% if program.is_live %}
                        <span class="radio-tag radio-tag--live">Canlı</span>
                    {% elif program.is_active_time %}
                        <span class="radio-tag radio-tag--ready">Hazır</span>
                    {% elif program.is_upcoming %}
                        <span class="radio-tag radio-tag--soon">Yaklaşıyor</span>
                    {% else %}
                        <span class="radio-tag radio-tag--over">Bitti</span>
                    {% endif %}
                    <span class="radio-tag"><i class="bi bi-clock"></i> {{ program.duration_minutes }} dk</span>
                    <span class="radio-tag"><i class="bi bi-calendar"></i> {{ program.start_time|date:"d F Y, H:i" }}</span>
                </div>
            </div>
        </header>

        <div class="program-layout program-layout--focus-chat">
            <section class="program-panel program-panel--chat program-panel--wide">
                <div class="panel-title">Sohbet Odası</div>
                <div class="radio-chat">
                    <div class="radio-chat__messages" id="radio-chat-messages" data-last-id="{{ chat_last_id }}">
                        {% for message in chat_messages %}
                            <div class="radio-chat__message {% if message.user_id == user.id %}is-own{% endif %}" data-message-id="{{ message.id }}">
                                <img src="{% if message.user.userprofile.photo %}{{ message.user.userprofile.photo.url }}{% else %}{% static 'imgs/default_profile.jpg' %}{% endif %}" alt="{{ message.user.username }}" class="radio-chat__avatar">
                                <div class="radio-chat__bubble">
                                    <div class="radio-chat__meta">@{{ message.user.username }} · {{ message.created_at|date:"H:i" }}</div>
                                    <div class="radio-chat__text">{{ message.body }}</div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="radio-chat__empty" id="radio-chat-empty">Henüz mesaj yok.</div>
                        {% endfor %}
                    </div>

                    {% if not program.is_live %}
                        <div class="radio-chat__notice">Sohbet sadece canlı yayın sırasında aktiftir.</div>
                    {% elif not user.is_authenticated %}
                        <div class="radio-chat__notice">
                            Sohbete katılmak için <a href="{% url 'login' %}">giriş yap</a>.
                        </div>
                    {% else %}
                        <form class="radio-chat__form" id="radio-chat-form">
                            {% csrf_token %}
                            <textarea id="radio-chat-input" class="form-control" rows="2" maxlength="500" placeholder="Mesajını yaz..."></textarea>
                            <button type="submit" class="btn btn-theme-primary">
                                <i class="bi bi-send"></i> Gönder
                            </button>
                        </form>
                        <div class="radio-chat__hint">Enter ile gönder, Shift+Enter ile satır ekle.</div>
                    {% endif %}
                </div>
            </section>

            <section class="program-panel program-panel--compact">
                <div class="panel-title">Program Özeti</div>
                <div class="dj-card">
                    {% if program.dj.userprofile.photo %}
                        <img src="{{ program.dj.userprofile.photo.url }}" class="dj-avatar" alt="{{ program.dj.username }}">
                    {% else %}
                        <img src="{% static 'imgs/default_profile.jpg' %}" class="dj-avatar" alt="{{ program.dj.username }}">
                    {% endif %}
                    <div>
                        <div class="dj-name">DJ {{ program.dj.username }}</div>
                        <a href="{% url 'user_profile' program.dj.username %}" class="dj-link">Profili gör</a>
                    </div>
                </div>

                <div class="panel-meta">
                    <div class="meta-item"><i class="bi bi-calendar"></i> {{ program.start_time|date:"d F Y, H:i" }} - {{ program.end_time|date:"H:i" }}</div>
                    <div class="meta-item"><i class="bi bi-people"></i> {{ program.listener_count }} dinleyici</div>
                    <div class="meta-item"><i class="bi bi-clock"></i> {{ program.duration_minutes }} dakika</div>
                </div>
            </section>

            <section class="program-panel program-panel--live program-panel--compact">
                {% if program.is_live %}
                    <div class="panel-title panel-title--light">Canlı Yayın</div>
                    <div class="live-status">
                        <span class="live-dot"></span>
                        {% if user == program.dj %}
                            Canlı yayındasın
                        {% else %}
                            Canlı yayın
                        {% endif %}
                    </div>
                    <div class="listener-pill">
                        <i class="bi bi-people"></i>
                        <span id="listener-count">{{ program.listener_count }}</span> kişi dinliyor
                    </div>

                    {% if user == program.dj %}
                        <div id="dj-status" class="panel-text">
                            Mikrofonun aktif. Konuşabilir ve müzik çalabilirsin.
                            <small id="audio-source-status">Ses kaynağı: Mikrofon</small>
                        </div>

                        <div class="panel-field">
                            <label for="mic-selector" class="form-label">
                                <i class="bi bi-mic"></i> Mikrofon Seçimi
                            </label>
                            <select id="mic-selector" class="form-select">
                                <option value="">Yükleniyor...</option>
                            </select>
                        </div>

                        <div class="control-actions">
                            <button id="share-music-btn" class="btn btn-theme-primary">
                                <i class="bi bi-music-note-beamed"></i> Müzik Paylaş
                            </button>
                            <button id="stop-music-btn" class="btn btn-theme-secondary" style="display: none;">
                                <i class="bi bi-mic"></i> Mikrofona Dön
                            </button>
                            <button id="stop-broadcast-btn" class="btn btn-theme-secondary">
                                <i class="bi bi-stop-circle"></i> Yayını Bitir
                            </button>
                        </div>

                        <div id="dj-controls" style="display: none;">
                            <div id="local-player"></div>
                        </div>
                    {% else %}
                        <div class="control-actions">
                            <button id="join-broadcast-btn" class="btn btn-theme-primary">
                                <i class="bi bi-play-circle"></i> Dinlemeye Başla
                            </button>
                            <button id="leave-broadcast-btn" class="btn btn-theme-secondary" style="display: none;">
                                <i class="bi bi-stop-circle"></i> Dinlemeyi Durdur
                            </button>
                        </div>

                        <div class="panel-field">
                            <label for="volume-control" class="form-label">
                                <i class="bi bi-volume-up"></i> Ses Seviyesi
                            </label>
                            <input type="range" class="form-range" id="volume-control" min="0" max="100" value="80">
                        </div>

                        <div id="remote-players" style="display: none;"></div>
                    {% endif %}
                {% else %}
                    <div class="panel-title panel-title--light">Yayın Durumu</div>
                    <div class="panel-text">
                        {% if program.is_finished %}
                            Bu program sona erdi.
                        {% elif program.is_upcoming %}
                            Bu program henüz başlamadı. Başlangıç: {{ program.start_time|date:"d F Y, H:i" }}
                        {% else %}
                            Bu program şu anda canlı değil.
                        {% endif %}
                    </div>

                    {% if user == program.dj and program.is_active_time and not program.is_finished %}
                        <div class="control-actions">
                            <button id="start-broadcast-btn" class="btn btn-theme-primary">
                                <i class="bi bi-play-circle"></i> Yayını Başlat
                            </button>
                        </div>
                    {% endif %}
                {% endif %}
            </section>
        </div>

        <div class="radio-footer">
            <a href="{% url 'radio_home' %}" class="btn btn-outline-theme-secondary">
                <i class="bi bi-arrow-left"></i> Radyo Ana Sayfasına Dön
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Agora SDK -->
<script>
// CRITICAL: Block Agora stats collector requests BEFORE loading SDK
(function() {
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        const url = args[0];
        const urlString = typeof url === 'string' ? url : url.url;

        if (urlString && (
            urlString.includes('statscollector') ||
            urlString.includes('agora.io/events') ||
            urlString.includes('sd-rtn.com/events')
        )) {
            return Promise.resolve(new Response('{"success":true}', {
                status: 200,
                headers: { 'Content-Type': 'application/json' }
            }));
        }

        return originalFetch.apply(this, args);
    };

    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url, ...rest) {
        if (url && (
            url.includes('statscollector') ||
            url.includes('agora.io/events') ||
            url.includes('sd-rtn.com/events')
        )) {
            this.addEventListener('load', function() {});
            this.send = function() {
                this.readyState = 4;
                this.status = 200;
                this.responseText = '{"success":true}';
            };
            return;
        }
        return originalOpen.call(this, method, url, ...rest);
    };
})();
</script>

<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

<script>
// Agora SDK global configuration - MUST be before any client creation
AgoraRTC.setLogLevel(4);
AgoraRTC.disableLogUpload();

if (typeof window.getCookie !== 'function') {
    window.getCookie = function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
}

const programId = {{ program.id }};
const isLive = {{ program.is_live|yesno:'true,false' }};
const isDJ = {{ user.id|default:'null' }} === {{ program.dj.id }};
const chatEndpoint = "{% url 'radio_chat_messages' program.id %}";

let agoraClient;
let localAudioTrack;
let screenAudioTrack;
let remoteUsers = {};
let APP_ID = null;
let isSharingMusic = false;
let selectedMicrophoneId = null;

const dom = {
    joinBtn: document.getElementById('join-broadcast-btn'),
    leaveBtn: document.getElementById('leave-broadcast-btn'),
    startBtn: document.getElementById('start-broadcast-btn'),
    stopBtn: document.getElementById('stop-broadcast-btn'),
    shareBtn: document.getElementById('share-music-btn'),
    stopShareBtn: document.getElementById('stop-music-btn'),
    micSelector: document.getElementById('mic-selector'),
    volumeControl: document.getElementById('volume-control'),
    listenerCount: document.getElementById('listener-count'),
    audioSourceStatus: document.getElementById('audio-source-status')
};

function getCsrfToken() {
    const metaToken = document.querySelector('meta[name=\"csrf-token\"]');
    if (metaToken && metaToken.content && metaToken.content !== 'NOTPROVIDED') {
        return metaToken.content;
    }
    if (typeof getCookie === 'function') {
        return getCookie('csrftoken');
    }
    return null;
}

function initAgoraClient() {
    agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    agoraClient.on('user-published', handleUserPublished);
    agoraClient.on('user-unpublished', handleUserUnpublished);
    agoraClient.on('user-left', handleUserLeft);
    agoraClient.on('user-joined', handleUserJoined);
}

function handleUserJoined() {
    updateListenerCount();
}

async function handleUserPublished(user, mediaType) {
    await agoraClient.subscribe(user, mediaType);

    if (mediaType === 'audio') {
        remoteUsers[user.uid] = user;
        if (user.audioTrack) {
            user.audioTrack.play();
        }
    }
    updateListenerCount();
}

function handleUserUnpublished(user, mediaType) {
    if (mediaType === 'audio') {
        delete remoteUsers[user.uid];
    }
    updateListenerCount();
}

function handleUserLeft(user) {
    delete remoteUsers[user.uid];
    updateListenerCount();
}

function updateListenerCount() {
    if (!agoraClient || !dom.listenerCount) return;
    const totalUsers = agoraClient.remoteUsers.length + 1;
    dom.listenerCount.textContent = totalUsers;

    const csrftoken = getCsrfToken();
    if (!csrftoken) return;

    fetch(`/radio/listener-count/${programId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ count: totalUsers })
    }).catch(() => {});
}

async function getAgoraToken() {
    const csrftoken = getCsrfToken();
    const response = await fetch(`/radio/token/${programId}/`, {
        method: 'GET',
        headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
    });

    if (!response.ok) {
        let errorMessage = 'Agora token alınamadı';
        try {
            const data = await response.json();
            errorMessage = data.error || errorMessage;
        } catch (e) {
            // ignore
        }
        throw new Error(errorMessage);
    }

    return await response.json();
}

async function joinChannel(tokenData, uid) {
    APP_ID = tokenData.app_id;
    await agoraClient.join(APP_ID, tokenData.channel_name, tokenData.token, uid);
}

async function ensureMicrophoneList() {
    if (!dom.micSelector) return;

    const renderList = (microphones) => {
        dom.micSelector.innerHTML = '';
        if (!microphones.length) {
            dom.micSelector.innerHTML = '<option value="">Mikrofon bulunamadı</option>';
            dom.micSelector.disabled = true;
            return;
        }
        dom.micSelector.disabled = false;
        microphones.forEach((mic, index) => {
            const option = document.createElement('option');
            option.value = mic.deviceId;
            option.text = mic.label || `Mikrofon ${index + 1}`;
            dom.micSelector.appendChild(option);
        });
        selectedMicrophoneId = microphones[0].deviceId;
    };

    try {
        let microphones = await AgoraRTC.getMicrophones();
        const hasLabels = microphones.some(mic => mic.label);

        if (!hasLabels) {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (error) {
                showToast('Mikrofon izni verilmedi.', 'error');
            }
            microphones = await AgoraRTC.getMicrophones();
        }

        renderList(microphones);
    } catch (error) {
        dom.micSelector.innerHTML = '<option value="">Mikrofon yüklenemedi</option>';
        dom.micSelector.disabled = true;
    }
}

function bindControls() {
    const csrftoken = getCsrfToken();

    if (isDJ && dom.startBtn) {
        dom.startBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`/radio/dj/start/${programId}/`, {
                    method: 'POST',
                    headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Yayın başlatılıyor...', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToast(data.error || 'Yayın başlatılamadı', 'error');
                }
            } catch (error) {
                showToast('Yayın başlatılamadı', 'error');
            }
        });
    }

    if (isDJ && dom.stopBtn) {
        dom.stopBtn.addEventListener('click', async () => {
            if (!confirm('Yayını bitirmek istediğinize emin misiniz?')) return;

            try {
                if (localAudioTrack) localAudioTrack.close();
                if (agoraClient) {
                    try {
                        await agoraClient.leave();
                    } catch (err) {
                        // ignore
                    }
                }

                const response = await fetch(`/radio/dj/stop/${programId}/`, {
                    method: 'POST',
                    headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Yayın sonlandırıldı', 'success');
                    setTimeout(() => window.location.href = '{% url "dj_dashboard" %}', 1500);
                } else {
                    showToast(data.error || 'Yayın sonlandırılamadı', 'error');
                }
            } catch (error) {
                showToast('Yayın sonlandırılamadı', 'error');
            }
        });
    }

    if (dom.joinBtn) {
        dom.joinBtn.addEventListener('click', async () => {
            try {
                showToast('Yayına bağlanılıyor...', 'info');
                const tokenData = await getAgoraToken();
                await joinChannel(tokenData, {{ user.id }});

                dom.joinBtn.style.display = 'none';
                if (dom.leaveBtn) dom.leaveBtn.style.display = 'inline-flex';

                showToast('Yayını dinliyorsunuz', 'success');
            } catch (error) {
                showToast(error.message || 'Yayına bağlanılamadı', 'error');
            }
        });
    }

    if (dom.leaveBtn) {
        dom.leaveBtn.addEventListener('click', async () => {
            try {
                await agoraClient.leave();
                dom.joinBtn.style.display = 'inline-flex';
                dom.leaveBtn.style.display = 'none';
                showToast('Dinleme durduruldu', 'info');
            } catch (error) {
                showToast('Bir hata oluştu', 'error');
            }
        });
    }

    if (dom.volumeControl) {
        dom.volumeControl.addEventListener('input', function() {
            const volume = this.value / 100;
            Object.values(remoteUsers).forEach(user => {
                if (user.audioTrack) {
                    user.audioTrack.setVolume(volume * 100);
                }
            });
        });
    }

    if (dom.micSelector) {
        dom.micSelector.addEventListener('change', async function() {
            selectedMicrophoneId = this.value;
            if (localAudioTrack && !isSharingMusic && selectedMicrophoneId) {
                try {
                    await localAudioTrack.setDevice(selectedMicrophoneId);
                    showToast('Mikrofon değiştirildi', 'success');
                } catch (error) {
                    showToast('Mikrofon değiştirilemedi', 'error');
                }
            }
        });
    }

    if (dom.shareBtn) {
        dom.shareBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });

                const audioTracks = stream.getAudioTracks();
                if (!audioTracks.length) {
                    stream.getTracks().forEach(track => track.stop());
                    showToast('Ses paylaşımı algılanmadı. Bir sekmeyi paylaşırken "sekme sesi" seçeneğini işaretle.', 'error');
                    return;
                }

                stream.getVideoTracks().forEach(track => track.stop());

                screenAudioTrack = await AgoraRTC.createCustomAudioTrack({
                    mediaStreamTrack: audioTracks[0]
                });

                if (localAudioTrack) {
                    await agoraClient.unpublish([localAudioTrack]);
                }
                await agoraClient.publish([screenAudioTrack]);

                isSharingMusic = true;
                dom.shareBtn.style.display = 'none';
                if (dom.stopShareBtn) dom.stopShareBtn.style.display = 'inline-flex';
                if (dom.audioSourceStatus) {
                    dom.audioSourceStatus.textContent = 'Ses kaynağı: Paylaşılan ekran';
                }

                audioTracks[0].addEventListener('ended', async () => {
                    if (isSharingMusic) {
                        await stopScreenShare();
                    }
                });

                showToast('Müzik paylaşımı başladı', 'success');
            } catch (error) {
                showToast('Müzik paylaşımı başlatılamadı', 'error');
            }
        });
    }

    if (dom.stopShareBtn) {
        dom.stopShareBtn.addEventListener('click', stopScreenShare);
    }
}

async function stopScreenShare() {
    try {
        if (screenAudioTrack) {
            await agoraClient.unpublish([screenAudioTrack]);
            screenAudioTrack.close();
        }
        if (localAudioTrack) {
            await agoraClient.publish([localAudioTrack]);
        }

        isSharingMusic = false;
        if (dom.shareBtn) dom.shareBtn.style.display = 'inline-flex';
        if (dom.stopShareBtn) dom.stopShareBtn.style.display = 'none';
        if (dom.audioSourceStatus) {
            dom.audioSourceStatus.textContent = 'Ses kaynağı: Mikrofon';
        }

        showToast('Mikrofona geri dönüldü', 'info');
    } catch (error) {
        showToast('Mikrofona dönülemedi', 'error');
    }
}

async function autoJoinDJ() {
    if (!isDJ || !isLive) return;

    try {
        const tokenData = await getAgoraToken();
        await joinChannel(tokenData, {{ user.id }});

        const micConfig = {
            encoderConfig: 'music_standard',
            AEC: true,
            AGC: true,
            ANS: true
        };

        if (selectedMicrophoneId) {
            micConfig.microphoneId = selectedMicrophoneId;
        }

        localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack(micConfig);
        await agoraClient.publish([localAudioTrack]);

        await ensureMicrophoneList();
    } catch (error) {
        showToast('Yayına bağlanırken hata oluştu', 'error');
    }
}

let autoEndHandled = false;
const programEndAt = new Date("{{ program.end_time|date:'c' }}");

function handleProgramEnd() {
    if (autoEndHandled) return;
    autoEndHandled = true;

    if (isDJ && dom.stopBtn) {
        const csrftoken = getCsrfToken();
        fetch(`/radio/dj/stop/${programId}/`, {
            method: 'POST',
            headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
        })
        .then(response => response.json())
        .then(() => {
            showToast('Program süresi doldu, yayın kapatıldı.', 'info');
            setTimeout(() => window.location.reload(), 1500);
        })
        .catch(() => {
            window.location.reload();
        });
    } else {
        showToast('Program süresi doldu.', 'info');
        setTimeout(() => window.location.reload(), 1500);
    }
}

function scheduleProgramEndCheck() {
    if (!isLive) return;
    if (!programEndAt || Number.isNaN(programEndAt.getTime())) return;
    const checkInterval = 30000;
    const intervalId = setInterval(() => {
        if (Date.now() >= programEndAt.getTime()) {
            clearInterval(intervalId);
            handleProgramEnd();
        }
    }, checkInterval);

    if (Date.now() >= programEndAt.getTime()) {
        clearInterval(intervalId);
        handleProgramEnd();
    }
}

const chatState = {
    container: document.getElementById('radio-chat-messages'),
    empty: document.getElementById('radio-chat-empty'),
    form: document.getElementById('radio-chat-form'),
    input: document.getElementById('radio-chat-input'),
    lastId: 0,
    pollingId: null
};

function initChatState() {
    if (!chatState.container) return;
    const lastId = parseInt(chatState.container.dataset.lastId || '0', 10);
    chatState.lastId = Number.isNaN(lastId) ? 0 : lastId;
    chatState.container.scrollTop = chatState.container.scrollHeight;
}

function renderChatMessage(message, shouldScroll) {
    if (!chatState.container) return;

    const row = document.createElement('div');
    row.className = `radio-chat__message${message.is_own ? ' is-own' : ''}`;
    row.dataset.messageId = message.id;

    const avatar = document.createElement('img');
    avatar.className = 'radio-chat__avatar';
    avatar.src = message.avatar_url;
    avatar.alt = message.username;

    const bubble = document.createElement('div');
    bubble.className = 'radio-chat__bubble';

    const meta = document.createElement('div');
    meta.className = 'radio-chat__meta';
    meta.textContent = `@${message.username} · ${message.created_at}`;

    const text = document.createElement('div');
    text.className = 'radio-chat__text';
    text.textContent = message.body;

    bubble.appendChild(meta);
    bubble.appendChild(text);
    row.appendChild(avatar);
    row.appendChild(bubble);

    if (chatState.empty) {
        chatState.empty.remove();
        chatState.empty = null;
    }

    chatState.container.appendChild(row);

    if (shouldScroll) {
        chatState.container.scrollTop = chatState.container.scrollHeight;
    }
}

async function fetchChatMessages() {
    if (!chatState.container) return;

    try {
        const response = await fetch(`${chatEndpoint}?after=${chatState.lastId}`);
        if (!response.ok) return;

        const data = await response.json();
        if (!data.messages || !data.messages.length) return;

        const shouldScroll = chatState.container.scrollTop + chatState.container.clientHeight >= chatState.container.scrollHeight - 80;

        data.messages.forEach(message => {
            chatState.lastId = Math.max(chatState.lastId, message.id);
            renderChatMessage(message, shouldScroll);
        });
    } catch (error) {
        // silent
    }
}

async function sendChatMessage() {
    if (!chatState.form || !chatState.input) return;

    const body = chatState.input.value.trim();
    if (!body) return;

    if (!isLive) {
        showToast('Sohbet sadece canlı yayında aktif.', 'info');
        return;
    }

    const formData = new FormData();
    formData.append('body', body);

    const csrftoken = getCsrfToken();
    const headers = csrftoken ? { 'X-CSRFToken': csrftoken } : {};

    try {
        const response = await fetch(chatEndpoint, {
            method: 'POST',
            headers,
            body: formData
        });

        const data = await response.json();
        if (!response.ok) {
            showToast(data.error || 'Mesaj gönderilemedi', 'error');
            return;
        }

        chatState.input.value = '';
        chatState.lastId = Math.max(chatState.lastId, data.message.id);
        renderChatMessage(data.message, true);
    } catch (error) {
        showToast('Mesaj gönderilemedi', 'error');
    }
}

function initChatForm() {
    if (!chatState.form || !chatState.input) return;

    chatState.form.addEventListener('submit', function(event) {
        event.preventDefault();
        sendChatMessage();
    });

    chatState.input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage();
        }
    });
}

function startChatPolling() {
    if (!chatState.container) return;
    fetchChatMessages();
    chatState.pollingId = setInterval(fetchChatMessages, 4000);
}

if (isLive) {
    initAgoraClient();
}

bindControls();
if (isDJ && dom.micSelector) {
    ensureMicrophoneList();
}
if (isDJ && isLive) {
    autoJoinDJ();
}
scheduleProgramEndCheck();
initChatState();
initChatForm();
startChatPolling();
</script>
{% endblock %}
