{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<div class="container py-4">
  <div class="row g-4">
    <!-- SOL SÜTUN: Kurallar + Form + Kendi Kehanetlerin -->
    <div class="col-lg-3 col-12 order-2 order-lg-1">
      <div class="accordion mb-4" id="rulesAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingRules">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseRules" aria-expanded="false" aria-controls="collapseRules">
              Delphoi Kuralları
            </button>
          </h2>
          <div id="collapseRules" class="accordion-collapse collapse" aria-labelledby="headingRules">
            <div class="accordion-body">
              <ul>
                <li>Her gün Kahine <b>bir kere</b> danışabilirsiniz.</li>
                <li><b>En fazla 3 pozitif ve 3 negatif</b> kehanet girebilirsiniz.</li>
                <li><b>Pozitif ve negatif</b> kehanet zorunlu. İki kehaneti birden yapmalısınız.</li>
                <li>Her kehanet <b>en fazla 300 karakter</b> olabilir.</li>
                <li>Kehanetler <b>anonimdir</b>.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <details class="delphoi-side-section mb-3">
        <summary class="delphoi-side-summary">
          Kehanetlerini Yaz
          <span class="delphoi-side-meta">{{ positive_count }}/3 · {{ negative_count }}/3</span>
        </summary>
        <div class="pt-3">
          <form id="delphoi-form" method="post" class="p-3 border rounded" style="background-color: var(--hover-background-color);">
            {% csrf_token %}
            <div class="mb-2">
              {{ form.positive.label_tag }} {{ form.positive }}
              <div class="text-end small">
                Girilen: {{ positive_count }}/3
                {% if positive_count >= 3 %}<span class="text-theme-danger"> (limit doldu)</span>{% endif %}
              </div>
            </div>
            <div class="mb-2">
              {{ form.negative.label_tag }} {{ form.negative }}
              <div class="text-end small">
                Girilen: {{ negative_count }}/3
                {% if negative_count >= 3 %}<span class="text-theme-danger"> (limit doldu)</span>{% endif %}
              </div>
            </div>
            <div class="text-center">
              <button type="submit" id="submit_prophecies_btn" class="btn-theme mt-3" {% if disable_form %}disabled{% endif %}>
                Kehanetleri Gönder
              </button>
            </div>
            {% if disable_form %}
              <div class="alert alert-warning mt-3 p-2 text-center">
                3 pozitif ve 3 negatif kehanet sınırına ulaştınız.
              </div>
            {% endif %}
          </form>
        </div>
      </details>

      <details class="delphoi-side-section">
        <summary class="delphoi-side-summary">
          Kendi Kehanetlerin
          <span class="delphoi-side-meta">{{ prophecies|length }}</span>
        </summary>
        <div class="pt-3">
          <div class="accordion" id="myPropheciesAccordion">
        {% for prophecy in prophecies %}
          <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="heading{{prophecy.id}}">
              <button class="accordion-button collapsed d-flex align-items-center{% if edit_id == prophecy.id or updated_id == prophecy.id %} show{% endif %}"
                      type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapse{{prophecy.id}}" aria-expanded="false" aria-controls="collapse{{prophecy.id}}">
                <span class="me-2">{{ forloop.counter }}.</span>
                {% if prophecy.type == 'positive' %}
                  <span class="badge me-2" style="background-color: var(--button-background-color); color: var(--button-text-color);">Pozitif</span>
                {% else %}
                  <span class="badge me-2" style="background-color: var(--secondary-button-background-color); color: var(--secondary-button-text-color);">Negatif</span>
                {% endif %}
                <span class="ms-auto small text-muted">{{ prophecy.created_at|date:"d.m.Y H:i" }}</span>
              </button>
            </h2>
            <div id="collapse{{prophecy.id}}" class="accordion-collapse collapse{% if edit_id == prophecy.id or updated_id == prophecy.id %} show{% endif %}"
                 aria-labelledby="heading{{prophecy.id}}" data-bs-parent="#myPropheciesAccordion">
              <div class="accordion-body">
                {% if update_message and updated_id == prophecy.id %}
                  <div class="alert alert-success py-2 mb-2">{{ update_message }}</div>
                {% endif %}
                {% if edit_id == prophecy.id %}
                  <form method="post" action="?edit={{prophecy.id}}">
                    {% csrf_token %}
                    {% if prophecy.type == 'positive' %}
                      <div class="mb-2">
                        <label class="form-label">Pozitif Kehanet</label>
                        {{ edit_form.positive }}
                      </div>
                    {% else %}
                      <div class="mb-2">
                        <label class="form-label">Negatif Kehanet</label>
                        {{ edit_form.negative }}
                      </div>
                    {% endif %}
                    <button type="submit" name="save_edit" class="btn btn-theme-primary btn-sm">Kaydet</button>
                    <a href="{% url 'delphoi_home' %}#collapse{{prophecy.id}}" class="btn btn-theme-secondary btn-sm ms-2">Vazgeç</a>
                  </form>
                {% else %}
                  <div class="mb-2">{{ prophecy.text }}</div>
                  <form method="get" style="display:inline;">
                    <input type="hidden" name="edit" value="{{ prophecy.id }}">
                    <button class="btn-theme btn-sm" type="submit">Düzenle</button>
                  </form>
                  <form method="post" style="display:inline;" id="delete-prophecy-form-{{ prophecy.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="delete_id" value="{{ prophecy.id }}">
                    <button class="btn btn-theme-secondary btn-sm ms-2" type="submit" class="delete-prophecy-btn" data-prophecy-id="{{ prophecy.id }}">Sil</button>
                  </form>
                {% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="alert alert-info p-2 text-center mb-0">Hiç kehanet girmemişsiniz.</div>
        {% endfor %}
          </div>
        </div>
      </details>
    </div>

    <!-- SAĞ SÜTUN: Kahin (ana deneyim) -->
    <div class="col-lg-9 col-12 order-1 order-lg-2">
      <div class="delphoi-oracle sticky-top">
        <div class="delphoi-hero">
          <img src="{% static 'imgs/delphoi.gif' %}" alt="Delphoi Kahini" class="delphoi-hero-gif">
          <div id="countdown" class="delphoi-countdown" style="display:none;" aria-hidden="true"></div>

          <div class="delphoi-hero-inner">
            <div class="delphoi-hero-kicker">Delphoi Tapınağı</div>
            <h1 class="delphoi-hero-title">Kahin</h1>
            <div class="delphoi-hero-subtitle">Yanıtını duymaya geldin.</div>

            <div class="delphoi-hero-actions">
              <button id="get_prophecy_btn"
                      class="btn btn-theme-primary btn-lg delphoi-ask-btn"
                      {% if not can_request_prophecy %}disabled{% endif %}>
                Yanıtı Duy
              </button>
              <div class="delphoi-actions-hint">
                Geri sayım başlayacak; 5 saniye sonra kehanet açığa çıkacak.
              </div>
            </div>
          </div>
        </div>

        <div class="delphoi-prophecy-card">
          <div class="delphoi-prophecy-head">Kehanet</div>
          <div id="prophecyResult" class="delphoi-prophecy" role="status" aria-live="polite">
            {% if prophecy_result %}
              <blockquote class="delphoi-prophecy-quote">{{ prophecy_result }}</blockquote>
            {% elif not can_request_prophecy and wait_until %}
              <div class="delphoi-prophecy-empty">Bugünlük kehanet hakkını kullandın.</div>
            {% else %}
              <div class="delphoi-prophecy-empty">Henüz bir şey söylenmedi. “Yanıtı Duy” ile çağır.</div>
            {% endif %}
          </div>

          {% if not can_request_prophecy and wait_until %}
            <div class="delphoi-wait">
              Tekrar danışmak için <span id="waitTime">{{ wait_until|date:"d.m.Y H:i" }}</span> beklemelisin.
            </div>
            <script>
              // Kalan zamanı canlı göster
              const waitUntil = new Date("{{ wait_until|date:'Y-m-d H:i:s' }}".replace(' ', 'T'));
              function updateWaitTime() {
                const now = new Date();
                let diff = Math.max(0, (waitUntil - now)/1000);
                let h = Math.floor(diff/3600);
                let m = Math.floor((diff%3600)/60);
                let s = Math.floor(diff%60);
                document.getElementById('waitTime').innerText =
                  (h>0 ? h+' saat, ':'') + (m>0 ? m+' dk ':'') + s + ' sn';
              }
              updateWaitTime();
              setInterval(updateWaitTime, 1000);
            </script>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  let positive = document.getElementById('id_positive');
  let negative = document.getElementById('id_negative');
  let btn = document.getElementById('submit_prophecies_btn');

  function checkFields() {
    if (btn && positive && negative) {
      btn.disabled = !(positive.value.trim().length > 0 && negative.value.trim().length > 0);
    }
  }
  if (positive && negative) {
    positive.addEventListener('input', checkFields);
    negative.addEventListener('input', checkFields);
    checkFields();
  }

  let getProphecyBtn = document.getElementById('get_prophecy_btn');
  let countdownDiv = document.getElementById('countdown');
  if (getProphecyBtn) {
    getProphecyBtn.addEventListener('click', function(e) {
      // Günlük kısıtlama varsa JS'de de kontrol et.
      if (getProphecyBtn.disabled) return;
      e.preventDefault();
      let sec = 5;
      countdownDiv.style.display = 'flex';
      countdownDiv.textContent = sec;
      getProphecyBtn.disabled = true;
      let interval = setInterval(function() {
        sec -= 1;
        countdownDiv.textContent = sec;
        if (sec <= 0) {
          clearInterval(interval);
          countdownDiv.style.display = 'none';
          window.location.href = "{% url 'delphoi_result' %}";
        }
      }, 1000);
    });
  }

  // Handle prophecy deletion with confirmation dialog
  const deleteProphecyBtns = document.querySelectorAll('.delete-prophecy-btn');
  deleteProphecyBtns.forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const prophecyId = this.getAttribute('data-prophecy-id');
      const form = document.getElementById('delete-prophecy-form-' + prophecyId);
      showConfirm('Bu kehaneti silmek istediğine emin misin?', 'Kehaneti Sil', 'Evet, Sil', 'btn-theme-secondary').then(result => {
        if (result) {
          form.submit();
        }
      });
    });
  });
});
</script>
{% endblock %}

<style>
    .prophecy-field {
      font-size: 1.05rem;
      min-height: 48px;
      resize: vertical;
    }
    #prophecyResult {
      font-size: 1.25rem;
      min-height: 80px;
    }
    .accordion-item {
      border-radius: 8px !important;
      overflow: hidden;
      border: 1px solid var(--border-color, #dee2e6);
    }
    .accordion-item + .accordion-item {
      margin-top: 8px;
    }
    .badge {
      font-size: .85em;
      padding: 0.5em 0.7em;
    }
    /* Sticky top behavior for right column GIF and results */
    @media (max-width: 991px) {
      .sticky-top {
        position: static !important;
      }
    }
</style>
