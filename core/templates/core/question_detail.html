  {% extends 'core/base.html' %}
  {% load static %}
  {% load custom_tags %}
  {% load markdownify %}

  {% block title %}{{ question.question_text }} - Hafif Ayaklar{% endblock %}

  {% block meta_description %}{{ question.question_text }}{% if answers_page %} - En beğenilen yanıt: {{ answers_page.0.answer_text|striptags|truncatewords:25 }} ({{ answers_page|length }} topluluk yanıtı){% endif %} | Hafif Ayaklar{% endblock %}

  {% block meta_keywords %}{{ question.question_text }}, soru, cevap, tartışma{% endblock %}

  {% block canonical_url %}{{ request.scheme }}://{{ request.get_host }}/{{ question.slug }}/{% endblock %}

  {% block og_type %}article{% endblock %}
  {% block og_title %}{{ question.question_text }}{% endblock %}
  {% block og_description %}{{ question.question_text }}{% if answers_page %} - {{ answers_page|length }} yanıt{% endif %}{% endblock %}
  {% block og_url %}{{ request.scheme }}://{{ request.get_host }}/{{ question.slug }}/{% endblock %}

  {% block twitter_title %}{{ question.question_text }}{% endblock %}
  {% block twitter_description %}{{ question.question_text }}{% if answers_page %} - {{ answers_page|length }} yanıt{% endif %}{% endblock %}
  {% block twitter_url %}{{ request.scheme }}://{{ request.get_host }}/{{ question.slug }}/{% endblock %}

  {% block article_section %}{{ question.question_text }}{% endblock %}
  {% block article_tags %}{{ question.question_text }}, soru, cevap{% if answers_page %}, {{ answers_page|length }} yanıt{% endif %}{% endblock %}

  {% block ai_structured_data %}
  <!-- JSON-LD Structured Data for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "QAPage",
    "mainEntity": {
      "@type": "Question",
      "name": "{{ question.question_text|escapejs }}",
      "text": "{{ question.question_text|escapejs }}",
      "answerCount": {{ answers_page|length|default:0 }},
      "dateCreated": "{{ question.created_at|date:'c' }}",
      "author": {
        "@type": "Person",
        "name": "{{ question.author.username|default:'Anonymous'|escapejs }}"
      }{% if answers_page and answers_page|length > 0 %},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ answers_page.0.answer_text|striptags|truncatewords:100|escapejs }}",
        "dateCreated": "{{ answers_page.0.created_at|date:'c' }}",
        "upvoteCount": {{ answers_page.0.upvote_count|default:0 }},
        "author": {
          "@type": "Person",
          "name": "{{ answers_page.0.author.username|escapejs }}"
        }
      },
      "suggestedAnswer": [
        {% for answer in answers_page|slice:"1:4" %}
        {
          "@type": "Answer",
          "text": "{{ answer.answer_text|striptags|truncatewords:100|escapejs }}",
          "dateCreated": "{{ answer.created_at|date:'c' }}",
          "upvoteCount": {{ answer.upvote_count|default:0 }},
          "author": {
            "@type": "Person",
            "name": "{{ answer.author.username|escapejs }}"
          }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]{% endif %}
    }
  }
  </script>
  {% endblock %}

  {% block extra_css %}
  <style>
      .active-filter {
          background: var(--button-background-color, #6E8CA7) !important;
          color: var(--button-text-color, #fff) !important;
      }
      .active-filter i {
          color: var(--button-text-color, #fff) !important;
      }
  </style>
  {% endblock %}

  {% block content %}
  <div class="container mt-5" id="naber">
    <div class="row" style="height: 100vh; min-height: 500px;">
          <!-- SOL SÜTUN: TÜM SORULAR -->
          <div class="col-12 col-md-2 order-2 order-md-1 d-flex flex-column sol-scroll" style="border-right: 1px solid #ccc; height: 90%; min-height: 0;">
            <h4 style="display: flex; justify-content: center; align-items: center; gap: 18px; min-height: 38px; margin-bottom: 0.5rem;">
              <a href="#" id="random-question-btn" title="Rastgele Başlık Diz" class="vote-btn2 d-flex align-items-center justify-content-center"
                 style="width: 32px; height: 32px; border-radius: 50%; transition: background 0.2s;">
                  <i class="bi bi-shuffle" style="font-size: 1.25em"></i>
              </a>
              <a href="#" id="shuffle-btn" title="Rastgele Başlığa Git" class="vote-btn2 d-flex align-items-center justify-content-center"
                 style="width: 32px; height: 32px; border-radius: 50%; transition: background 0.2s;">
                  <i class="bi bi-asterisk" style="font-size: 1.25em"></i>
              </a>
              {% if user.is_authenticated %}
              <a href="?followed={% if show_followed_only %}0{% else %}1{% endif %}" id="followed-filter-btn"
                 title="{% if show_followed_only %}Tümünü Göster{% else %}Sadece Takip Ettiklerim{% endif %}"
                 class="vote-btn2 d-flex align-items-center justify-content-center {% if show_followed_only %}active-filter{% endif %}"
                 style="width: 32px; height: 32px; border-radius: 50%; transition: all 0.2s;">
                  <i class="bi bi-people-fill" style="font-size: 1.25em;"></i>
              </a>
              {% endif %}
          </h4>   
          <div style="flex:1 1 0; overflow-y:auto; min-height:0;">
            <ul class="list-unstyled" id="questions-list">
              {% for question in all_questions_page %}
              <li class="d-flex justify-content-between align-items-center mt-2 baslik">
                  <a href="{% url 'question_detail' question.slug %}{% if show_followed_only %}?followed=1{% endif %}"
                    class="tbas-color text-decoration-none d-flex justify-content-between align-items-center w-100">
                      <span>{{ question.question_text }}</span>
                      <small class="text-muted ms-2" style="min-width: 20px; text-align: right;">{{ question.answers_count }}</small>
                  </a>
              </li>
              {% endfor %}
          </ul>
          </div>       
              {% include 'core/pagination.html' with page_obj=all_questions_page page_param='q_page' %}
          </div>
          
        <!-- ORTA SÜTUN -->
        <div class="col-12 col-md-8 order-1 order-md-2 d-flex flex-column sol-scroll" style="height: 100%; min-height: 0;">
          <div style="flex:1 1 0; overflow-y:auto; min-height:0;">
          
            <!-- Gizli input: question.id -->
            <input type="hidden" id="answer_form_question_id" value="{{ question.id }}">
          
            <!-- Soru Başlık + Harita Linki + FİLTRE BUTONU -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              
              <h1 class="h1 mb-0">
                <a href="{% url 'question_detail' question.slug %}" class="text-decoration-none" style="color: inherit;">{{ question.question_text }}</a>

                {# Haritada Gör butonu (mevcut özelliğin değişmedi) #}
                {% if is_on_map %}
                  <a href="{% url 'question_map' %}?question_id={{ question.id }}" 
                     class="ms-2 text-secondary topic-small-icon"
                     title="Haritada Gör">
                    <i class="bi bi-geo-alt-fill"></i>
                  </a>
                {% endif %}
              
                {# YENİ: Eğer bu başlık bir anketle ilişkiliyse, anket ikonunu göster #}
                {% with poll=question.poll_set.first %}
                {% if poll %}
                <span class="ms-2 poll-icon-wrapper" data-poll-id="{{ poll.id }}">
                  <i class="bi bi-pie-chart poll-icon topic-small-icon"></i>
                </span>
                {% endif %}
              {% endwith %}
              </h1>
              
              
              <!-- Filtre / Huni Butonu (Bootstrap Dropdown) -->
              <div class="dropdown">
                <button class="btn btn-sm dropdown-toggle"
                        type="button"
                        id="filterDropdownBtn"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                  <i class="bi bi-funnel"></i> 
                </button>
          
                <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="filterDropdownBtn"
                    style="min-width: 280px;">
                  <!-- Filtre Formu -->
                  <form id="filterForm" autocomplete="off">
                    
                    <!-- Kendi Yanıtlarım & Takip Ettiklerim -->
                    <div class="mb-2 form-check">
                      <input class="form-check-input" type="checkbox"
                            name="my_answers" value="on" id="myAnswersCheck"
                            {% if my_answers == 'on' %}checked{% endif %}>
                      <label class="form-check-label" for="myAnswersCheck">
                        Benim Yanıtlarım
                      </label>
                    </div>
                    <div class="mb-2 form-check">
                      <input class="form-check-input" type="checkbox"
                            name="followed" value="on" id="followedCheck"
                            {% if followed == 'on' %}checked{% endif %}>
                      <label class="form-check-label" for="followedCheck">
                        Takip Ettiklerim
                      </label>
                    </div>
          
                    <!-- Kullanıcı Adı -->
                    <div class="mb-2">
                      <input type="text"
                            class="form-control form-control-sm"
                            name="username"
                            placeholder="Kullanıcı Adı"
                            value="{{ filter_username|default_if_none:'' }}">
                    </div>
          
                    <!-- Anahtar Kelime -->
                    <div class="mb-2">
                      <input type="text"
                            class="form-control form-control-sm"
                            name="keyword"
                            placeholder="Kelime Ara"
                            value="{{ filter_keyword|default_if_none:'' }}">
                    </div>
                    
                    <!-- Filtrele Butonu (isteğe göre gizleyebilirsiniz, 
                        eğer tamamen canlı arama yapmak istiyorsanız. ) -->
                    <button type="submit" class="btn btn-sm btn-theme-primary w-100">
                      Uygula
                    </button>
                  </form>
                </div>
              </div>
              <!-- /Filtre Dropdown -->
            </div>
            <!-- /Soru Başlık Satırı -->
          
            <!-- Soruya Oy ve Kaydet -->
            <div class="action d-flex justify-content-between align-items-center mb-3">
              <div>
                <!-- Oy Butonları -->
                <a href="#"
                  class="vote-btn me-1 {% if question.user_vote_value == 1 %}voted-up{% endif %}"
                  data-content-type="question" data-object-id="{{ question.id }}" data-value="1" title="Beğen">
                  <i class="bi bi-chevron-up"></i>
                </a>
                <span class="icon-number" id="question-upvotes">{{ question.upvotes }}</span>
          
                <a href="#"
                  class="vote-btn ms-1 me-1 {% if question.user_vote_value == -1 %}voted-down{% endif %}"
                  data-content-type="question" data-object-id="{{ question.id }}" data-value="-1" title="Beğenme">
                  <i class="bi bi-chevron-down"></i>
                </a>
                <span class="icon-number" id="question-downvotes">{{ question.downvotes }}</span>
          
                <!-- Kaydet -->
                <a href="#"
                  class="save-btn ms-2"
                  data-content-type="question" data-object-id="{{ question.id }}"
                  title="Kaydet">
                  <i class="{% if user_has_saved_question %}bi bi-bookmark-fill{% else %}bi bi-bookmark{% endif %}"></i>
                </a>
                <span class="save-count icon-number">{{ question_save_count }}</span>

                {% if user.is_authenticated %}
                <!-- Takip Et -->
                <a href="#"
                   class="follow-question-btn ms-2"
                   data-question-id="{{ question.id }}"
                   title="{% if user_is_following_question %}Takibi Bırak{% else %}Takip Et{% endif %}">
                  <i class="bi {% if user_is_following_question %}bi-bell-fill text-primary{% else %}bi-bell{% endif %}"></i>
                </a>

                <!-- Mevcut Başlığı Bağla -->
                <a href="#"
                   class="ms-2"
                   data-bs-toggle="modal"
                   data-bs-target="#linkExistingQuestionModal"
                   title="Mevcut Başlığı Alt Soru Olarak Ekle">
                  <i class="bi bi-link-45deg"></i>
                </a>

                <!-- Üst Sorulardan Bağlantıyı Kaldır (makas ikonu) -->
                {% if parents_list %}
                <a href="#"
                   class="ms-1"
                   data-bs-toggle="modal"
                   data-bs-target="#unlinkParentsModal"
                   title="Üst Sorulardan Bağlantıyı Kaldır"
                   style="font-size: 0.85em;">
                  <i class="bi bi-scissors"></i>
                </a>
                {% endif %}
                {% endif %}
              </div>
              <div class="text-end">
                <small class="">
                  <a href="{% url 'user_profile' question.user.username %}">
                    {{ question.user.username }}
                  </a> |
                  {{ question.created_at|date:"Y-m-d H:i" }}
                </small>
              </div>
            </div>
          
            <!-- YANITLAR LİSTESİ (Kapsayıcı) -->
            <div id="answersContainer">
              {% for answer in answers_page %}
                <div class="card mb-3 mt-2 answer random-item-card" id="answer-{{ answer.id }}">
                  <div class="card-body">
                    {% if answer.answer_text|length > 1000 %}
                      <div class="answer-text" id="answer-summary-{{ answer.id }}">
                        {{ answer.answer_text|slice:":1000"|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }} ...
                      </div>
                      <div class="answer-text" id="answer-full-{{ answer.id }}" style="display: none;">
                        {{ answer.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}

                        {# Kaynakça Bölümü #}
                        {% with bibliography=answer.answer_text|extract_bibliography %}
                          {% if bibliography %}
                            <div class="bibliography-section mt-4 pt-3 border-top">
                              <h6 class="bibliography-title d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#bibliography-full-{{ answer.id }}" aria-expanded="false" style="cursor: pointer; user-select: none;">
                                <span>Kaynakça <small class="text-muted">({{ bibliography|length }})</small></span>
                                <i class="bi bi-chevron-down bibliography-chevron" style="font-size: 0.9rem;"></i>
                              </h6>
                              <div id="bibliography-full-{{ answer.id }}" class="collapse">
                                <ol class="bibliography-list">
                                  {% for item in bibliography %}
                                    <li class="bibliography-item">
                                      {% if item.reference %}
                                        <span class="reference-citation">
                                          {{ item.formatted_authors }}{% if item.reference.metin_ismi %}. <em>{{ item.reference.metin_ismi }}</em>{% endif %} ({{ item.reference.year }}). {{ item.reference.rest }}{% if item.reference.abbreviation %} [{{ item.reference.abbreviation }}]{% endif %}{% if item.pages %}, s. {{ item.pages|join:", " }}{% endif %}.
                                        </span>
                                      {% else %}
                                        <span class="reference-not-found">Kaynak bulunamadı (ID: {{ item.ref_id }})</span>
                                      {% endif %}
                                    </li>
                                  {% endfor %}
                                </ol>
                              </div>
                            </div>
                          {% endif %}
                        {% endwith %}
                      </div>
                      <a href="#" class="read-more" data-answer-id="{{ answer.id }}">Tümünü Göster</a>
                    {% else %}
                      <div class="answer-text">
                        {{ answer.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}

                        {# Kaynakça Bölümü #}
                        {% with bibliography=answer.answer_text|extract_bibliography %}
                          {% if bibliography %}
                            <div class="bibliography-section mt-4 pt-3 border-top">
                              <h6 class="bibliography-title d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#bibliography-full-{{ answer.id }}" aria-expanded="false" style="cursor: pointer; user-select: none;">
                                <span>Kaynakça <small class="text-muted">({{ bibliography|length }})</small></span>
                                <i class="bi bi-chevron-down bibliography-chevron" style="font-size: 0.9rem;"></i>
                              </h6>
                              <div id="bibliography-full-{{ answer.id }}" class="collapse">
                                <ol class="bibliography-list">
                                  {% for item in bibliography %}
                                    <li class="bibliography-item">
                                      {% if item.reference %}
                                        <span class="reference-citation">
                                          {{ item.formatted_authors }}{% if item.reference.metin_ismi %}. <em>{{ item.reference.metin_ismi }}</em>{% endif %} ({{ item.reference.year }}). {{ item.reference.rest }}{% if item.reference.abbreviation %} [{{ item.reference.abbreviation }}]{% endif %}{% if item.pages %}, s. {{ item.pages|join:", " }}{% endif %}.
                                        </span>
                                      {% else %}
                                        <span class="reference-not-found">Kaynak bulunamadı (ID: {{ item.ref_id }})</span>
                                      {% endif %}
                                    </li>
                                  {% endfor %}
                                </ol>
                              </div>
                            </div>
                          {% endif %}
                        {% endwith %}
                      </div>
                    {% endif %}
          
                    <!-- Oy/Kaydet + Kullanıcı Bilgisi -->
                    <div class="action d-flex justify-content-between align-items-center">
                      <div>
                        <!-- Oy butonları -->
                        <a href="#" class="vote-btn me-1 {% if answer.user_vote_value == 1 %}voted-up{% endif %}"
                          data-content-type="answer" data-object-id="{{ answer.id }}" data-value="1" 
                          title="Beğen">
                          <i class="bi bi-chevron-up"></i>
                        </a>
                        <span class="icon-number" id="answer-upvotes-{{ answer.id }}">{{ answer.upvotes }}</span>
          
                        <a href="#" class="vote-btn ms-1 me-1 {% if answer.user_vote_value == -1 %}voted-down{% endif %}"
                          data-content-type="answer" data-object-id="{{ answer.id }}" data-value="-1" 
                          title="Beğenme">
                          <i class="bi bi-chevron-down"></i>
                        </a>
                        <span class="icon-number" id="answer-downvotes-{{ answer.id }}">{{ answer.downvotes }}</span>
          
                        <a href="#" class="save-btn ms-2"
                          data-content-type="answer" data-object-id="{{ answer.id }}"
                          title="Kaydet">
                          <i class="{% if answer.id in saved_answer_ids %}bi bi-bookmark-fill{% else %}bi bi-bookmark{% endif %}"></i>
                        </a>
                        <span class="save-count icon-number">{{ answer_save_dict|get_item:answer.id|default:"0" }}</span>

                        {% if answer.user == request.user %}
                              <a href="{% url 'edit_answer' answer.id %}" class="ms-2" title="Yanıtı Düzenle">
                                  <i class="bi bi-pencil-square "></i>
                              </a>
                          <a href="#" class="ms-2 delete-answer-btn"
                            data-answer-id="{{ answer.id }}"
                            data-delete-url="{% url 'delete_answer' answer.id %}?next={{ request.path|urlencode }}"
                            title="Sil" data-bs-toggle="modal" data-bs-target="#deleteAnswerModal">
                            <i class="bi bi-trash "></i>
                          </a>
                        {% endif %}
                      </div>
                      <div class="text-end">
                        <small class="me-2">
                          <a href="{% url 'user_profile' answer.user.username %}">{{ answer.user.username }}</a>
                          | {{ answer.created_at|date:"Y-m-d H:i" }}
                          {% if answer.updated_at|date:"Y-m-d H:i:s" > answer.created_at|date:"Y-m-d H:i:s" %}
                            {% if answer.updated_at|date:"Y-m-d" == answer.created_at|date:"Y-m-d" %}
                              ~ {{ answer.updated_at|date:"H:i" }}
                            {% else %}
                              ~ {{ answer.updated_at|date:"Y-m-d H:i" }}
                            {% endif %}
                          {% endif %}
                        </small>
                        <!-- Dropdown menü (Link Kopyala, Paylaş vb.) -->
                        <div class="dropdown d-inline">
                          <a href="#" class="text-decoration-none dropdown-toggle-dots" id="dropdownMenu{{ answer.id }}"
                            data-bs-toggle="dropdown" aria-expanded="false"
                            style="padding: 4px 8px; display: inline-block; min-width: 24px; text-align: center;">
                            &#8226;&#8226;&#8226;
                          </a>
                          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenu{{ answer.id }}">
                            <li>
                              <button class="dropdown-item copy-link-btn"
                                      data-url="{% url 'single_answer' question.slug answer.id %}">
                                <i class="bi bi-link-45deg"></i> Linki Kopyala
                              </button>
                            </li>
                            <li>
                              <a class="dropdown-item share-link" href="#" data-answer-id="{{ answer.id }}">
                                <i class="bi bi-share"></i> Paylaş
                              </a>
                            </li>
                            <li>
                              <form action="{% url 'pin_entry' answer_id=answer.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                  <i class="bi bi-pin-angle"></i> Profile Sabitle
                                </button>
                              </form>
                            </li>
                            {% if request.user != answer.user %}
                            <li>
                              <a class="dropdown-item" href="{% url 'send_message_from_answer' answer.id %}">
                                <i class="bi bi-envelope"></i> Mesaj Gönder
                              </a>
                            </li>
                            {% endif %}
                            <li id="word-count-{{ answer.id }}" style="text-align:center;">
                              Kelime Sayısı: ...
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div> <!-- /.action -->
                  </div> <!-- /.card-body -->
                </div> <!-- /.card -->
              {% empty %}
                <p>Henüz yanıt yok. İlk yanıtı siz verin!</p>
              {% endfor %}
            </div>
            <!-- /YANITLAR LİSTESİ -->
          
            <!-- Sayfalama -->
            {% include 'core/pagination.html' with page_obj=answers_page page_param='a_page' %}
          
            <!-- YANIT EKLEME FORMU -->
            {% if user.is_authenticated %}
            <div class="card mt-4">
              <div class="card-body yanit-card">
                <form method="post">
                  {% csrf_token %}
                  <div class="btn-toolbar mb-2 yanit-card" role="toolbar">
                    <!-- Bold/Italic -->
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary format-btn me-2"
                            data-format="bold" title="Kalınlaştır">
                      <i class="bi bi-type-bold"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary format-btn me-2"
                            data-format="italic" title="İtalikleştir">
                      <i class="bi bi-type-italic"></i>
                    </button>
                    <!-- Harici Link Ekle -->
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary insert-link-btn me-2"
                            title="Harici WEB Linki Ekleyin">
                      <i class="bi bi-link-45deg"></i> Link Ekle
                    </button>
                    <!-- (bkz:soru) -->
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary insert-reference-btn me-2"
                            title="Bir diğer Soru/başlığa referans ver">
                      (bkz:soru)
                    </button>
                    <!-- (ref:...) -->
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary insert-ref-link-btn me-2"
                            title="Renklendir/Yönlendir">
                      <i class="bi bi-box-arrow-in-up-right"></i> hede
                    </button>
                    <!-- TANIM MODAL BUTONU -->
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary me-2" id="showDefinitionModalBtn"
                            title="Tanım">
                      <i class="bi bi-book"></i> Tanım
                    </button>
                    <!-- KAYNAK MODAL BUTONU -->
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary me-2"
                            data-bs-toggle="modal"
                            data-bs-target="#kaynakRefModal"
                            title="Kaynak">
                      <i class="bi bi-journal"></i> Kaynak
                    </button>
                    <!-- SPOILER (YILDIZ) BUTONU -->
                    <button type="button" class="btn btn-sm btn-outline-theme-secondary me-2 spoiler-btn"
                            title="gizle">
                      *
                    </button>
                  </div>
                  {{ form.answer_text }}
                  <button type="submit" class="btn btn-theme-primary mt-2">Yanıtla</button>
                  <button type="button" class="btn btn-theme-secondary mt-2 ms-2" id="sabaha-birak-btn">Kenarda Dursun</button>
                  <span id="sabahabirak-feedback" style="display:none;" class="text-theme-success ms-2">Taslak kaydedildi!</span>
                </form>
              </div>
            </div>
            {% else %}
            <div class="card mt-4">
              <div class="card-body text-center">
                <p class="mb-3">Yanıt yazmak için üye olmalısınız.</p>
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-theme-primary">Giriş Yap</a>
                <a href="{% url 'signup' %}" class="btn btn-outline-theme-primary ms-2">Üye Ol</a>
              </div>
            </div>
            {% endif %}
          
            </div>
        </div>
          <!-- SAĞ SÜTUN: ALT SORULAR -->
          <div class="col-12 col-md-2 order-3 order-md-3 d-flex flex-column" style="border-left: 1px solid #ccc; height: 100%; min-height: 0;">
            <div style="flex:1 1 0; overflow-y:auto; min-height:0;">
                  <div class="row g-2">  <!-- Satır ekledik, boşluk için g-2 kullanıldı -->
                      {% if parents_list|length == 0 %}
                      <div class="col-12 d-grid">
                          <a href="{% url 'add_subquestion' question.slug %}" class="btn btn-outline-theme-secondary btn-sm">
                              <i class="bi bi-chevron-double-down" title="Alt Soru Ekle"> Alt Soru Ekle</i>
                          </a>
                      </div>

                      {% elif parents_list|length > 0 %}
                      <div class="col-6 d-grid">
                          <a href="{% url 'add_subquestion' question.slug %}" class="btn btn-outline-theme-secondary btn-sm">
                              <i class="bi bi-chevron-double-down" title="Alt Soru Ekle"> Alt Soru Ekle</i>
                          </a>
                      </div>
                      {% endif %}


                      {% if parents_list|length == 1 %}
                          {% with parent_item=parents_list.0 %}
                              <div class="col-6 d-grid">
                                  <a href="{% url 'question_detail' parent_item.question.slug %}" class="btn btn-outline-theme-secondary btn-sm">
                                      <i class="bi bi-chevron-double-up" title="Üst Soruya Git"> Üst Soruya Git</i>
                                  </a>
                              </div>
                          {% endwith %}
                      {% elif parents_list|length > 1 %}
                          <div class="col-6 d-grid">
                              <button type="button" class="btn btn-outline-theme-secondary btn-sm"
                                      data-bs-toggle="modal" data-bs-target="#parentQuestionsModal">
                                  <i class="bi bi-chevron-double-up" title="Üst Soruya Git"> Üst Soruya Git</i>
                              </button>
                          </div>

                          <div class="modal fade" id="parentQuestionsModal" tabindex="-1"
                              aria-labelledby="parentQuestionsModalLabel" aria-hidden="true">
                              <div class="modal-dialog">
                                  <div class="modal-content">
                                      <div class="modal-header">
                                          <h5 class="modal-title">Üst Sorular</h5>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                  aria-label="Kapat"></button>
                                      </div>
                                      <div class="modal-body">
                                          <ul class="list-group parent-questions-list">
                                              {% for parent_item in parents_list %}
                                                  <li class="list-group-item d-flex justify-content-between align-items-center">
                                                      <div>
                                                          <a href="{% url 'question_detail' parent_item.question.slug %}">
                                                              {{ parent_item.question.question_text }}
                                                          </a>
                                                          <br>
                                                          <small class="">
                                                              <a href="{% url 'user_profile' parent_item.question.user.username %}">
                                                                  {{ parent_item.question.user.username }}
                                                              </a>
                                                          </small>
                                                          {% if parent_item.added_by_users|length > 1 %}
                                                          <br>
                                                          <small class="text-muted">
                                                              Ekleyenler:
                                                              {% for user in parent_item.added_by_users|slice:":3" %}
                                                                  <a href="{% url 'user_profile' user.username %}">{{ user.username }}</a>{% if not forloop.last %}, {% endif %}
                                                              {% endfor %}
                                                              {% if parent_item.added_by_users|length > 3 %}
                                                                  <span title="{% for user in parent_item.added_by_users|slice:'3:' %}{{ user.username }}{% if not forloop.last %}, {% endif %}{% endfor %}">
                                                                      +{{ parent_item.added_by_users|length|add:"-3" }} kişi daha
                                                                  </span>
                                                              {% endif %}
                                                          </small>
                                                          {% endif %}
                                                      </div>
                                                      <div class="d-flex gap-2">
                                                          <a href="{% url 'question_map' %}?question_id={{ parent_item.question.id }}" title="Haritada Gör">
                                                              <i class="bi bi-geo-alt"></i>
                                                          </a>
                                                          {% if request.user in parent_item.added_by_users %}
                                                          <a href="#" class="text-theme-danger unlink-parent"
                                                             data-parent-id="{{ parent_item.question.id }}"
                                                             data-parent-title="{{ parent_item.question.question_text }}"
                                                             title="Bağlantıyı Kaldır">
                                                              <i class="bi bi-link-45deg"></i>
                                                          </a>
                                                          {% endif %}
                                                      </div>
                                                  </li>
                                              {% endfor %}
                                          </ul>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      {% endif %}

                      <!-- Unlink from Parents Modal (başlıktaki unlink ikonundan açılır) -->
                      <div class="modal fade" id="unlinkParentsModal" tabindex="-1"
                           aria-labelledby="unlinkParentsModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                              <div class="modal-content">
                                  <div class="modal-header">
                                      <h5 class="modal-title">Üst Sorulardan Bağlantıyı Kaldır</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal"
                                              aria-label="Kapat"></button>
                                  </div>
                                  <div class="modal-body">
                                      <p class="text-muted mb-3">Bu soruyu bağlı olduğu üst sorulardan ayırabilirsiniz:</p>
                                      <ul class="list-group unlink-parents-list">
                                          {% for parent_item in parents_list %}
                                              {% if request.user in parent_item.added_by_users %}
                                              <li class="list-group-item d-flex justify-content-between align-items-center">
                                                  <div>
                                                      <a href="{% url 'question_detail' parent_item.question.slug %}">
                                                          {{ parent_item.question.question_text }}
                                                      </a>
                                                      <br>
                                                      <small class="text-muted">
                                                          <a href="{% url 'user_profile' parent_item.question.user.username %}">
                                                              {{ parent_item.question.user.username }}
                                                          </a>
                                                      </small>
                                                      {% if parent_item.added_by_users|length > 1 %}
                                                      <br>
                                                      <small class="text-muted">
                                                          Diğer ekleyenler:
                                                          {% for user in parent_item.added_by_users|slice:":3" %}
                                                              {% if user != request.user %}
                                                                  <a href="{% url 'user_profile' user.username %}">{{ user.username }}</a>{% if not forloop.last %}, {% endif %}
                                                              {% endif %}
                                                          {% endfor %}
                                                          {% if parent_item.added_by_users|length > 3 %}
                                                              <span title="{% for user in parent_item.added_by_users|slice:'3:' %}{% if user != request.user %}{{ user.username }}{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}">
                                                                  +{{ parent_item.added_by_users|length|add:"-3" }} kişi daha
                                                              </span>
                                                          {% endif %}
                                                      </small>
                                                      {% endif %}
                                                  </div>
                                                  <div>
                                                      <button type="button" class="btn btn-sm btn-outline-theme-secondary unlink-parent"
                                                              data-parent-id="{{ parent_item.question.id }}"
                                                              data-parent-title="{{ parent_item.question.question_text }}"
                                                              title="Bağlantıyı Kaldır">
                                                          Kaldır
                                                      </button>
                                                  </div>
                                              </li>
                                              {% endif %}
                                          {% endfor %}
                                      </ul>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- Unlink Confirmation Modal -->
                      <div class="modal fade" id="unlinkConfirmModal" tabindex="-1"
                           aria-labelledby="unlinkConfirmModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                              <div class="modal-content">
                                  <div class="modal-header">
                                      <h5 class="modal-title" id="unlinkConfirmModalLabel">Bağlantıyı Kaldır</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal"
                                              aria-label="Kapat"></button>
                                  </div>
                                  <div class="modal-body">
                                      <p id="unlinkConfirmMessage"></p>
                                      <p class="text-muted small">Not: Bu soru silinmez, sadece üst soruyla olan bağlantısı kopar.</p>
                                  </div>
                                  <div class="modal-footer">
                                      <button type="button" class="btn btn-theme-primary" data-bs-dismiss="modal">İptal</button>
                                      <button type="button" class="btn btn-theme-secondary" id="confirmUnlinkBtn">Evet, Kaldır</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- Subquestions List -->
                  <ul class="list-group mt-2 subquestions-list">
                      {% if subquestions_list %}
                          {% for subq_item in subquestions_list %}
                              <li class="list-group-item d-flex justify-content-between align-items-center">
                                  <div>
                                      <a href="{% url 'question_detail' subq_item.question.slug %}">
                                          {{ subq_item.question.question_text }}
                                      </a>
                                      <br>
                                      <small class="">
                                          <a href="{% url 'user_profile' subq_item.question.user.username %}">
                                              {{ subq_item.question.user.username }}
                                          </a>
                                      </small>
                                      {% if subq_item.added_by_users|length > 1 %}
                                      <br>
                                      <small class="text-muted">
                                          Ekleyenler:
                                          {% for user in subq_item.added_by_users|slice:":3" %}
                                              <a href="{% url 'user_profile' user.username %}">{{ user.username }}</a>{% if not forloop.last %}, {% endif %}
                                          {% endfor %}
                                          {% if subq_item.added_by_users|length > 3 %}
                                              <span title="{% for user in subq_item.added_by_users|slice:'3:' %}{{ user.username }}{% if not forloop.last %}, {% endif %}{% endfor %}">
                                                  +{{ subq_item.added_by_users|length|add:"-3" }} kişi daha
                                              </span>
                                          {% endif %}
                                      </small>
                                      {% endif %}
                                  </div>
                                  <div class="d-flex gap-2">
                                      <a href="{% url 'question_map' %}?question_id={{ subq_item.question.id }}" title="Haritada Gör">
                                          <i class="bi bi-geo-alt"></i>
                                      </a>
                                  </div>
                              </li>
                          {% endfor %}
                      {% endif %}
                  </ul>
              </div>
          </div>
  </div>
</div>




  {% include 'core/link_modal.html' %}
  {% include 'core/kaynak_ref.html' %}
  {% include 'core/reference_modal.html' %}

  <!-- Yanıt Silme Modal -->
  <div class="modal fade" id="deleteAnswerModal" tabindex="-1" aria-labelledby="deleteAnswerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" id="delete-answer-form">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="deleteAnswerModalLabel">Yanıtı Sil</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <div class="modal-body">
            <p>Bu yanıtı silmek istediğinizden emin misiniz?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-theme-primary" data-bs-dismiss="modal">İptal</button>
            <button type="submit" class="btn btn-theme-secondary">Evet, Sil</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- TANIM MODAL -->
  <div class="modal fade" id="definitionModal" tabindex="-1" aria-labelledby="definitionModalLabel" aria-hidden="true" data-question-slug="{{ question.slug }}">
      <div class="modal-dialog modal-lg"> <!-- modal-lg: genişlik için -->
        <div class="modal-content">
    
          <!-- Modal Başlık -->
          <div class="modal-header">
            <h5 class="modal-title" id="definitionModalLabel">Tanım</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
    
          <!-- Modal Gövdesi (Sekmeler) -->
          <div class="modal-body">
            <ul class="nav nav-tabs" id="definitionTab" role="tablist">
              <!-- Sekme 1: TANIM YAP -->
              <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        id="tanim-yap-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#tanim-yap"
                        type="button"
                        role="tab"
                        aria-controls="tanim-yap"
                        aria-selected="true">
                  Tanım Yap
                </button>
              </li>
              <!-- Sekme 2: TANIMLARIM -->
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="tanim-bul-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#tanim-bul"
                        type="button"
                        role="tab"
                        aria-controls="tanim-bul"
                        aria-selected="false">
                  Tanımlarım
                </button>
              </li>
              <!-- Sekme 3: GENEL TANIM -->
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="genel-tanim-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#genel-tanim"
                        type="button"
                        role="tab"
                        aria-controls="genel-tanim"
                        aria-selected="false">
                  Genel Tanımlar
                </button>
              </li>
            </ul>
    
            <!-- Sekmelerin İçerikleri -->
            <div class="tab-content mt-3" id="definitionTabContent">
              
              <!-- (1) TANIM YAP -->
              <div class="tab-pane fade show active" id="tanim-yap" role="tabpanel" aria-labelledby="tanim-yap-tab">
                <form id="createDefinitionForm">
                  <div class="mb-3">
                    <label for="definitionText" class="form-label">Tanım (max 1000 karakter):</label>
                    <textarea class="form-control"
                              id="definitionText"
                              name="definition_text"
                              rows="4"
                              maxlength="1000"
                              placeholder="Tanımınızı girin..."></textarea>
                  </div>
                  <button type="submit" class="btn btn-theme-primary">Kaydet</button>
                </form>
              </div>
              
              <!-- (2) TANIMLARIM (Sadece bu kullanıcının tanımları) -->
              <div class="tab-pane fade" id="tanim-bul" role="tabpanel" aria-labelledby="tanim-bul-tab">
                <!-- Arama Kutusu -->
                <input type="text" class="form-control mb-2" id="userDefSearchInput" placeholder="Tanımlarımda ara..." />
                <!-- Liste (radio) -->
                <ul class="list-group" id="userDefinitionsList"></ul>
                <!-- Sayfalama Alanı -->
                <div id="userDefPagination" class="mt-2"></div>
                <!-- Seçili Tanımı Ekle -->
                <button type="button" class="btn btn-theme-primary mt-2" id="insertUserDefinitionBtn">Seçili Tanımı Ekle</button>
              </div>
              
              <!-- (3) GENEL TANIM (Tüm kullanıcıların tanımları) -->
              <div class="tab-pane fade" id="genel-tanim" role="tabpanel" aria-labelledby="genel-tanim-tab">
                <!-- Arama Kutusu -->
                <input type="text" class="form-control mb-2" id="allDefSearchInput" placeholder="Tüm tanımlarda ara..." />
                <!-- Liste (radio) -->
                <ul class="list-group" id="allDefinitionsList"></ul>
                <!-- Sayfalama Alanı -->
                <div id="allDefPagination" class="mt-2"></div>
                <!-- Seçili Tanımı Ekle -->
                <button type="button" class="btn btn-theme-primary mt-2" id="insertGlobalDefinitionBtn">Seçili Tanımı Ekle</button>
              </div>
              
            </div> <!-- /.tab-content -->
          </div> <!-- /.modal-body -->
    
          <!-- Modal Footer (opsiyonel) -->
          <div class="modal-footer">
            <button type="button" class="btn btn-theme-primary" data-bs-dismiss="modal">Kapat</button>
          </div>
    
        </div> <!-- /.modal-content -->
      </div> <!-- /.modal-dialog -->
    </div> <!-- /.modal -->
  <!-- PAYLAŞIM MODAL -->
  <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="shareModalLabel">Paylaş</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group">
                <li class="list-group-item">
                    <a href="#" id="shareTwitter" target="_blank" class="text-decoration-none">
                        <i class="bi bi-twitter text-primary"></i> X (Twitter) ile Paylaş
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="#" id="shareFacebook" target="_blank" class="text-decoration-none">
                        <i class="bi bi-facebook text-primary"></i> Facebook ile Paylaş
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="#" id="shareWhatsApp" target="_blank" class="text-decoration-none">
                        <i class="bi bi-whatsapp text-theme-success"></i> WhatsApp ile Paylaş
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="#" id="shareTelegram" target="_blank" class="text-decoration-none">
                        <i class="bi bi-telegram text-info"></i> Telegram ile Paylaş
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="#" id="shareLinkedIn" target="_blank" class="text-decoration-none">
                        <i class="bi bi-linkedin text-primary"></i> LinkedIn ile Paylaş
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="#" id="shareReddit" target="_blank" class="text-decoration-none">
                        <i class="bi bi-reddit text-theme-danger"></i> Reddit ile Paylaş
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="#" id="shareEmail" class="text-decoration-none">
                        <i class="bi bi-envelope"></i> E-posta ile Paylaş
                    </a>
                </li>
                <li class="list-group-item">
                    <button class="btn btn-sm w-100 text-start" id="shareCopyLink" style="border: none; background: none; padding: 0;">
                        <i class="bi bi-link-45deg"></i> Linki Kopyala
                    </button>
                </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  {% endblock %}

  {% block extra_js %}
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Mevcut tüm [data-bs-toggle="tooltip"] öğelerini seç ve Bootstrap Tooltip olarak başlat
          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
      });
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'js/answer_form.js' %}"></script>
  <script src="{% static 'js/vote_save.js' %}"></script>

  <!-- Okuma (Read More), Kopyala, Paylaş, Yanıt Silme vb. İşlemleri -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
      // OKUMA (Read More) İşlevi
      const readMoreLinks = document.querySelectorAll('.read-more');
      readMoreLinks.forEach(function(link) {
          link.addEventListener('click', function(event) {
              event.preventDefault();
              const answerId = this.getAttribute('data-answer-id');
              const summary = document.getElementById('answer-summary-' + answerId);
              const fullText = document.getElementById('answer-full-' + answerId);
              if (!summary || !fullText) return;
              
              // Computed stil ile summary'nin görünürlüğünü kontrol et
              const summaryDisplay = window.getComputedStyle(summary).display;
              if (summaryDisplay !== 'none') {
                  summary.style.display = 'none';
                  fullText.style.display = 'block';
                  this.textContent = 'Daha az göster';
              } else {
                  summary.style.display = 'block';
                  fullText.style.display = 'none';
                  this.textContent = 'Tümünü Göster';
              }
          });
      });

      // Link Kopyala İşlevi (Toast ile)
      $('.copy-link-btn').click(function(e) {
          e.preventDefault();
          var url = $(this).data('url');
          var absoluteLink = window.location.origin + url;

          // Modern clipboard API kullan
          if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(absoluteLink).then(function() {
                  showToast('Link panoya kopyalandı!', 'Başarılı', 3000);
              }).catch(function() {
                  // Fallback eski yöntem
                  var tempInput = $("<input>");
                  $("body").append(tempInput);
                  tempInput.val(absoluteLink).select();
                  document.execCommand("copy");
                  tempInput.remove();
                  showToast('Link panoya kopyalandı!', 'Başarılı', 3000);
              });
          } else {
              // Fallback eski yöntem
              var tempInput = $("<input>");
              $("body").append(tempInput);
              tempInput.val(absoluteLink).select();
              document.execCommand("copy");
              tempInput.remove();
              showToast('Link panoya kopyalandı!', 'Başarılı', 3000);
          }
      });

      // Paylaş (Share) İşlevi
      var currentAnswerId;
      // Paylaş butonuna tıklanınca ilgili answer ID'sini al ve paylaş modal'ını göster
      $('.share-link').click(function(e) {
          e.preventDefault();
          currentAnswerId = $(this).data('answer-id');
          $('#shareModal').modal('show');
      });
      
      // Soru slug'ını şablondan alıyoruz (paylaş URL'sinde kullanılacak)
      var questionSlug = "{{ question.slug }}";
      // Django URL şablonundan, paylaşım linki için bir template URL oluşturuyoruz.
      // "0" placeholder olarak kullanılıyor; modal açıldığında bu değeri currentAnswerId ile değiştireceğiz.
      var shareUrlTemplate = "{% url 'single_answer' question.slug 0 %}";
      
      $('#shareModal').on('shown.bs.modal', function () {
          // "0" kısmını currentAnswerId ile değiştiriyoruz
          var shareUrl = shareUrlTemplate.replace('/0/', '/' + currentAnswerId + '/');
          var absoluteLink = window.location.origin + shareUrl;
          var questionTitle = "{{ question.question_text|escapejs }}";

          // Paylaşım URL'lerini oluştur
          var twitterUrl = "https://twitter.com/intent/tweet?url=" + encodeURIComponent(absoluteLink) + "&text=" + encodeURIComponent(questionTitle);
          var facebookUrl = "https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(absoluteLink);
          var whatsappUrl = "https://wa.me/?text=" + encodeURIComponent(questionTitle + " " + absoluteLink);
          var telegramUrl = "https://t.me/share/url?url=" + encodeURIComponent(absoluteLink) + "&text=" + encodeURIComponent(questionTitle);
          var linkedinUrl = "https://www.linkedin.com/sharing/share-offsite/?url=" + encodeURIComponent(absoluteLink);
          var redditUrl = "https://reddit.com/submit?url=" + encodeURIComponent(absoluteLink) + "&title=" + encodeURIComponent(questionTitle);
          var emailUrl = "mailto:?subject=" + encodeURIComponent(questionTitle) + "&body=" + encodeURIComponent("Bu yanıta göz atmanı öneririm: " + absoluteLink);

          // Link'leri ata
          $('#shareTwitter').attr('href', twitterUrl);
          $('#shareFacebook').attr('href', facebookUrl);
          $('#shareWhatsApp').attr('href', whatsappUrl);
          $('#shareTelegram').attr('href', telegramUrl);
          $('#shareLinkedIn').attr('href', linkedinUrl);
          $('#shareReddit').attr('href', redditUrl);
          $('#shareEmail').attr('href', emailUrl);

          // Linki Kopyala butonu
          $('#shareCopyLink').off('click').on('click', function(e) {
              e.preventDefault();
              if (navigator.clipboard && navigator.clipboard.writeText) {
                  navigator.clipboard.writeText(absoluteLink).then(function() {
                      showToast('Link panoya kopyalandı!', 'Başarılı', 3000);
                      $('#shareModal').modal('hide');
                  });
              } else {
                  var tempInput = $("<input>");
                  $("body").append(tempInput);
                  tempInput.val(absoluteLink).select();
                  document.execCommand("copy");
                  tempInput.remove();
                  showToast('Link panoya kopyalandı!', 'Başarılı', 3000);
                  $('#shareModal').modal('hide');
              }
          });
      });

          // Yanıt Silme İşlevi
          var deleteAnswerModal = document.getElementById('deleteAnswerModal');
    deleteAnswerModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      var deleteUrl = button.getAttribute('data-delete-url');
      var form = deleteAnswerModal.querySelector('#delete-answer-form');
      form.action = deleteUrl;
    });
  });
  </script>
<!-- oy ver popover -->
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Bootstrap Popover'ları başlat
          var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
          var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
              return new bootstrap.Popover(popoverTriggerEl, {
                  html: true,
                  container: 'body',
              });
          });
      });
  </script>

<!-- Yanıt alanı genişletme -->
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Sadece "auto-expand" sınıfına sahip textarea'ya odaklanıldığında genişlet
          var textarea = document.querySelector('textarea.auto-expand');
          if (textarea) {
              textarea.addEventListener('focus', function() {
                  this.classList.add('expanded');
              });
          }
      });
  </script>


  <script>
      document.addEventListener('DOMContentLoaded', function() {
          const filterForm  = document.getElementById('filterForm');
          const answersDiv  = document.getElementById('answersContainer');
          const questionSlug = "{{ question.slug }}";
        
          // Filtre formundaki input'lara change/keyup event ekle
          filterForm.querySelectorAll('input').forEach(function(elem) {
              if (elem.type === 'text') {
                  elem.addEventListener('keyup', function() {
                      doFilterAjax();
                  });
              } else {
                  elem.addEventListener('change', function() {
                      doFilterAjax();
                  });
              }
          });
        
          // "Uygula" butonuna basıldığında (form submit)
          filterForm.addEventListener('submit', function(e) {
              e.preventDefault();
              doFilterAjax();
          });
        
          function doFilterAjax() {
              const formData = new FormData(filterForm);
              const queryParams = new URLSearchParams(formData);
              const url = `/${questionSlug}/filter_answers/?` + queryParams.toString();
              fetch(url, {
                  method: 'GET',
                  headers: { 'X-Requested-With': 'XMLHttpRequest' }
              })
              .then(response => response.text())
              .then(htmlData => {
                  answersDiv.innerHTML = htmlData;
                  // Ajax ile gelen yeni cevap kartlarında "Tümünü Göster" işlevini yeniden başlat
                  reinitReadMore();
              })
              .catch(err => {
                  console.error('Filtreleme hatası:', err);
              });
          }
        
          // Sayfa ilk yüklendiğinde read-more işlevini init et
          reinitReadMore();
        
          function reinitReadMore() {
              const readMoreLinks = answersDiv.querySelectorAll('.read-more');

              // localStorage'dan açık yanıtları al
              const expandedAnswers = JSON.parse(localStorage.getItem('expandedAnswers') || '[]');

              readMoreLinks.forEach(function(link) {
                  const answerId = link.getAttribute('data-answer-id');
                  const summary = document.getElementById('answer-summary-' + answerId);
                  const fullText = document.getElementById('answer-full-' + answerId);

                  if (!summary || !fullText) return;

                  // Eğer bu yanıt localStorage'da açık olarak işaretlenmişse, aç
                  if (expandedAnswers.includes(answerId)) {
                      summary.style.display = 'none';
                      fullText.style.display = 'block';
                      link.textContent = 'Daha az göster';
                  }

                  link.addEventListener('click', function(event) {
                      event.preventDefault();
                      const answerId = this.getAttribute('data-answer-id');
                      const summary = document.getElementById('answer-summary-' + answerId);
                      const fullText = document.getElementById('answer-full-' + answerId);
                      if (!summary || !fullText) return;

                      let expandedAnswers = JSON.parse(localStorage.getItem('expandedAnswers') || '[]');

                      if (summary.style.display === 'none') {
                          // Kapatıyoruz
                          summary.style.display = 'block';
                          fullText.style.display = 'none';
                          this.textContent = 'Tümünü Göster';

                          // localStorage'dan çıkar
                          expandedAnswers = expandedAnswers.filter(id => id !== answerId);
                      } else {
                          // Açıyoruz
                          summary.style.display = 'none';
                          fullText.style.display = 'block';
                          this.textContent = 'Daha az göster';

                          // localStorage'a ekle
                          if (!expandedAnswers.includes(answerId)) {
                              expandedAnswers.push(answerId);
                          }
                      }

                      localStorage.setItem('expandedAnswers', JSON.stringify(expandedAnswers));
                  });
              });
          }
      });


      document.addEventListener('DOMContentLoaded', function() {
    // localStorage'dan açık yanıtları al
    const expandedAnswers = JSON.parse(localStorage.getItem('expandedAnswers') || '[]');

    // Her seferinde event'ları kaldır ve ekle (önce var olanları silmek için)
    document.querySelectorAll('.read-more').forEach(function(link) {
        link.onclick = null;
        const answerId = link.getAttribute('data-answer-id');
        const summary = document.getElementById('answer-summary-' + answerId);
        const fullText = document.getElementById('answer-full-' + answerId);

        if (!summary || !fullText) return;

        // Eğer bu yanıt localStorage'da açık olarak işaretlenmişse, aç
        if (expandedAnswers.includes(answerId)) {
            summary.style.display = 'none';
            fullText.style.display = 'block';
            link.textContent = 'Daha az göster';
        }

        link.addEventListener('click', function(event) {
            event.preventDefault();
            var answerId = this.getAttribute('data-answer-id');
            var summary = document.getElementById('answer-summary-' + answerId);
            var fullText = document.getElementById('answer-full-' + answerId);
            if (!summary || !fullText) return;

            let expandedAnswers = JSON.parse(localStorage.getItem('expandedAnswers') || '[]');

            if (summary.style.display === 'none') {
                // Kapatıyoruz
                summary.style.display = 'block';
                fullText.style.display = 'none';
                this.textContent = 'Tümünü Göster';

                // localStorage'dan çıkar
                expandedAnswers = expandedAnswers.filter(id => id !== answerId);
            } else {
                // Açıyoruz
                summary.style.display = 'none';
                fullText.style.display = 'block';
                this.textContent = 'Daha az göster';

                // localStorage'a ekle
                if (!expandedAnswers.includes(answerId)) {
                    expandedAnswers.push(answerId);
                }
            }

            localStorage.setItem('expandedAnswers', JSON.stringify(expandedAnswers));
        });
    });
});
  </script>
<!-- poll -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
  
    /* Django’dan ters çözülmüş URL şablonları */
    const popTpl  = "{% url 'poll_popover'   0 %}";
    const voteTpl = "{% url 'vote_poll_ajax' 0 %}";
    const detTpl  = "{% url 'poll_detail'    0 %}";
  
    const openMap = new Map();   // pollId → {instance, hideTimer}
  

    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    function show(icon, pid){
      fetch(popTpl.replace('0', pid))
        .then(r => r.json())
        .then(d => {
          const pop = new bootstrap.Popover(icon, {
            html:true, trigger:'manual', content:d.html,
            placement:'top', sanitize:false, container:'body'
          });
          pop.show();
          const tip = pop.getTipElement();
          tip.addEventListener('mouseenter', () => {
            const o = openMap.get(pid); if (o?.hideTimer){ clearTimeout(o.hideTimer); o.hideTimer=null; }
          });
          tip.addEventListener('mouseleave', () => scheduleHide(pid));
          openMap.set(pid, {instance:pop, hideTimer:null});
        });
    }
  
    function scheduleHide(pid){
      const o = openMap.get(pid);
      if (!o || o.hideTimer) return;
      o.hideTimer = setTimeout(()=>{ o.instance.hide(); openMap.delete(pid); }, 200);
    }
  
    /* İkon olayları */
    document.querySelectorAll('.poll-icon-wrapper').forEach(w=>{
      const icon = w.querySelector('.poll-icon'), pid = w.dataset.pollId;
      icon.addEventListener('mouseenter', ()=>{ if(!openMap.has(pid)) show(icon,pid); });
      icon.addEventListener('mouseleave', ()=> scheduleHide(pid));
      icon.addEventListener('click',      ()=> window.location.href = detTpl.replace('0', pid));
    });
  
    /* Popover içinden AJAX oy */
    document.body.addEventListener('submit', e=>{
      if (!e.target.classList.contains('popover-vote-form')) return;
      e.preventDefault();
      const f=e.target, pid=f.dataset.pollId, fd=new FormData(f);
      fetch(voteTpl.replace('0', pid), {
        method:'POST', body:fd, credentials:'same-origin',
        headers:{'X-CSRFToken': getCookie('csrftoken')}

      })
      .then(r=>r.json())
      .then(d=>{
        const o=openMap.get(pid);
        if(o){
          o.instance.getTipElement().querySelector('.popover-body').innerHTML = d.html;
          // Otomatik kapat: (oy kullanımı başarılıysa)
          if (d.html.includes("Oyunuz kaydedildi")) {
            setTimeout(()=>{
              o.instance.hide();
              openMap.delete(pid);
            }, 750); 
          }
        }
      });
    });
  
  });
  </script>

<script>
document.getElementById('sabaha-birak-btn').onclick = function(e) {
    e.preventDefault();
    const content = document.getElementById('id_answer_text').value;
    const questionId = document.getElementById('answer_form_question_id').value;
    fetch("{% url 'kenarda_save' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            question_id: questionId,
            content: content
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'ok') {
            document.getElementById('sabahabirak-feedback').style.display = 'inline';
        } else {
            showToast('Bir hata oluştu: ' + (data.error || ''), 'error');
        }
    })
    .catch(err => {
        showToast('Sunucu hatası: ' + err, 'error');
    });
};

  </script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.yukle-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var content = btn.getAttribute('data-taslak-content');
                // Cevap kutusu ana sayfada veya başka bir yerde olabilir, önce var mı kontrol edelim
                var textarea = document.getElementById('id_answer_text');
                if (textarea) {
                    textarea.value = content;
                    textarea.focus();
                    // Modal kullanıyorsan modalı da açabilirsin, örn:
                    // $('#yanitModal').modal('show');
                } else {
                    showToast('Yanıt kutusu bulunamadı. Ana sayfada değilseniz orada deneyin.', 'warning');
                }
            });
        });
    });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Taslak içeriğini Django context'ten al (URL'den değil)
        {% if draft_content %}
        const draftContent = "{{ draft_content|escapejs }}";
        if (draftContent && document.getElementById('id_answer_text')) {
          document.getElementById('id_answer_text').value = draftContent;
          document.getElementById('id_answer_text').focus();
        }
        {% endif %}
      });
      </script>

<!-- sol frame -->
<script>
// Takip butonları
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrf-token]').content;

    // Başlık takip butonu
    const followQuestionBtn = document.querySelector('.follow-question-btn');
    if (followQuestionBtn) {
        followQuestionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const questionId = this.dataset.questionId;
            const icon = this.querySelector('i');
            const isFollowing = icon.classList.contains('bi-bell-fill');

            const url = isFollowing
                ? `/question/${questionId}/unfollow/`
                : `/question/${questionId}/follow/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isFollowing) {
                        icon.classList.remove('bi-bell-fill', 'text-primary');
                        icon.classList.add('bi-bell');
                        this.title = 'Takip Et';
                    } else {
                        icon.classList.remove('bi-bell');
                        icon.classList.add('bi-bell-fill', 'text-primary');
                        this.title = 'Takibi Bırak';
                    }
                }
            });
        });
    }
});

</script>


<!-- kelime sayma -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    function countWords(text) {
        return (text || '')
            .replace(/\n/g, ' ')
            .replace(/<[^>]*>/g, '')  // HTML etiketleri varsa sil
            .replace(/\[\d+\]/g, '')  // [1], [2], [3] gibi footnote numaralarını sil
            .replace(/\[\^\w+\]/g, '')  // [^ref], [^1] gibi footnote referanslarını sil
            .split(' ')
            .filter(word => word.trim().length > 0)
            .length;
    }

    function updateWordCount(answerId) {
        var summaryElem = document.getElementById('answer-summary-' + answerId);
        var fullElem    = document.getElementById('answer-full-' + answerId);
        var countElem   = document.getElementById('word-count-' + answerId);

        // --- YENİ: Kısa yanıtta summary yoksa doğrudan .answer-text'i bul ---
        var targetElem = null;
        if (fullElem && fullElem.style.display !== 'none') {
            targetElem = fullElem;
        } else if (summaryElem && summaryElem.style.display !== 'none') {
            targetElem = summaryElem;
        } else {
            // fallback: card içinde, ilgili yanıt id'sine sahip .answer-text'i bul
            var answerCard = document.getElementById('answer-' + answerId);
            if (answerCard) {
                targetElem = answerCard.querySelector('.answer-text');
            }
        }

        if (!countElem || !targetElem) return;

        // Clone the element to avoid modifying the original DOM
        var clonedElem = targetElem.cloneNode(true);

        // Remove bibliography section if it exists
        var bibliographySection = clonedElem.querySelector('.bibliography-section');
        if (bibliographySection) {
            bibliographySection.remove();
        }

        var text = clonedElem.innerText || clonedElem.textContent || '';
        var count = countWords(text);

        countElem.textContent = 'Kelime sayısı: ' + count;
    }

    // Tüm yanıtlar için başlat
    document.querySelectorAll('[id^=word-count-]').forEach(function(countElem) {
        var answerId = countElem.id.replace('word-count-', '');
        updateWordCount(answerId);
    });

    // Tümünü Göster tıklandığında tekrar hesapla
    document.querySelectorAll('.read-more').forEach(function(link) {
        link.addEventListener('click', function () {
            var answerId = this.getAttribute('data-answer-id');
            setTimeout(function() {
                updateWordCount(answerId);
            }, 20);
        });
    });
});

  </script>

  <!-- Link Existing Question Modal -->
  {% include 'core/link_existing_question_modal.html' %}

  <script src="{% static 'js/link_existing_question.js' %}"></script>

  <!-- Schema.org JSON-LD for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "QAPage",
    "mainEntity": {
      "@type": "Question",
      "name": "{{ question.question_text|escapejs }}",
      "text": "{{ question.question_text|escapejs }}",
      "answerCount": {{ answers_page|length|default:0 }},
      "upvoteCount": {{ question.upvotes|default:0 }},
      "dateCreated": "{{ question.created_at|date:'c' }}",
      "author": {
        "@type": "Person",
        "name": "{{ question.user.username|escapejs }}"
      }{% if answers_page %},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ answers_page.0.answer_text|striptags|truncatewords:50|escapejs }}",
        "upvoteCount": {{ answers_page.0.upvotes|default:0 }},
        "dateCreated": "{{ answers_page.0.created_at|date:'c' }}",
        "author": {
          "@type": "Person",
          "name": "{{ answers_page.0.user.username|escapejs }}"
        }
      }{% if answers_page|length > 1 %},
      "suggestedAnswer": [
        {% for answer in answers_page|slice:"1:" %}
        {
          "@type": "Answer",
          "text": "{{ answer.answer_text|striptags|truncatewords:50|escapejs }}",
          "upvoteCount": {{ answer.upvotes|default:0 }},
          "dateCreated": "{{ answer.created_at|date:'c' }}",
          "author": {
            "@type": "Person",
            "name": "{{ answer.user.username|escapejs }}"
          }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]{% endif %}{% endif %}
    }
  }
  </script>

  <!-- AI-Optimized FAQPage Schema for Better AI Discovery -->
  {% if answers_page %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "{{ question.question_text|escapejs }}",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "{{ answers_page.0.answer_text|striptags|escapejs }}",
          "upvoteCount": {{ answers_page.0.upvotes|default:0 }},
          "author": {
            "@type": "Person",
            "name": "{{ answers_page.0.user.username|escapejs }}"
          },
          "dateCreated": "{{ answers_page.0.created_at|date:'c' }}"
        }
      }
    ],
    "headline": "{{ question.question_text|escapejs }}",
    "description": "{{ question.question_text|escapejs }} - {{ answers_page|length }} topluluk yanıtı",
    "datePublished": "{{ question.created_at|date:'c' }}",
    "dateModified": "{{ question.updated_at|date:'c' }}",
    "author": {
      "@type": "Person",
      "name": "{{ question.user.username|escapejs }}"
    }
  }
  </script>
  {% endif %}

  <script>
  // Üst soru bağlantısını kaldırma (child question'ın perspective'inden)
  document.addEventListener('DOMContentLoaded', function() {
      let currentParentId = null;
      let currentParentTitle = null;
      const confirmModal = new bootstrap.Modal(document.getElementById('unlinkConfirmModal'));

      // Kaldır butonuna tıklandığında
      document.addEventListener('click', function(e) {
          const unlinkBtn = e.target.closest('.unlink-parent');
          if (!unlinkBtn) return;

          e.preventDefault();

          currentParentId = unlinkBtn.dataset.parentId;
          currentParentTitle = unlinkBtn.dataset.parentTitle;

          // Modal mesajını güncelle ve göster
          document.getElementById('unlinkConfirmMessage').textContent =
              `"${currentParentTitle}" sorusundan bağlantıyı kaldırmak istediğinize emin misiniz?`;
          confirmModal.show();
      });

      // Onay butonuna tıklandığında
      document.getElementById('confirmUnlinkBtn').addEventListener('click', function() {
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          fetch(`{{ request.path }}unlink-from-parent/${currentParentId}/`, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': csrftoken,
                  'Content-Type': 'application/json',
              },
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  confirmModal.hide();

                  // Üst soruyu her iki listeden de kaldır (hem unlink modal hem parent modal)
                  document.querySelectorAll(`[data-parent-id="${currentParentId}"]`).forEach(function(el) {
                      el.closest('li').remove();
                  });

                  // Her iki listeyi de kontrol et
                  const unlinkList = document.querySelector('.unlink-parents-list');
                  const parentList = document.querySelector('.parent-questions-list');

                  // Eğer hiç parent kalmadıysa modal'ları kapat ve sayfayı yenile
                  if ((unlinkList && unlinkList.querySelectorAll('li').length === 0) ||
                      (parentList && parentList.querySelectorAll('li').length === 0)) {
                      // Her iki modal'ı da kapat
                      const unlinkModal = bootstrap.Modal.getInstance(document.getElementById('unlinkParentsModal'));
                      const parentModal = bootstrap.Modal.getInstance(document.getElementById('parentQuestionsModal'));
                      if (unlinkModal) unlinkModal.hide();
                      if (parentModal) parentModal.hide();

                      // Sayfayı yenile (üst soru butonunu ve unlink ikonunu güncellemek için)
                      location.reload();
                  }

                  showToast(data.message, 'success');
              } else {
                  confirmModal.hide();
                  showToast('Hata: ' + data.error, 'error');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              confirmModal.hide();
              showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
          });
      });
  });
  </script>

  <script>
  // Bibliography chevron rotation
  document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.bibliography-section .collapse').forEach(function(collapseEl) {
          collapseEl.addEventListener('show.bs.collapse', function() {
              const chevron = this.previousElementSibling.querySelector('.bibliography-chevron');
              if (chevron) chevron.style.transform = 'rotate(180deg)';
          });
          collapseEl.addEventListener('hide.bs.collapse', function() {
              const chevron = this.previousElementSibling.querySelector('.bibliography-chevron');
              if (chevron) chevron.style.transform = 'rotate(0deg)';
          });
      });
  });
  </script>

  {% endblock %}

