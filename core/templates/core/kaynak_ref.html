<!-- core/kaynak_ref.html -->
<div class="modal fade" id="kaynakRefModal" tabindex="-1" aria-labelledby="kaynakRefModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- Modal Başlık -->
      <div class="modal-header">
        <h5 class="modal-title" id="kaynakRefModalLabel">Kaynak İşlemleri</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <!-- Modal İçeriği (Sekmeler) -->
      <div class="modal-body">
        <ul class="nav nav-tabs" id="kaynakTab" role="tablist">
          <!-- Kaynak Ekle Sekmesi -->
          <li class="nav-item" role="presentation">
            <button 
              class="nav-link active"
              id="kaynak-ekle-tab"
              data-bs-toggle="tab"
              data-bs-target="#kaynakEkle"
              type="button" 
              role="tab"
              aria-controls="kaynakEkle"
              aria-selected="true">
              Kaynak Ekle
            </button>
          </li>

          <!-- Kaynak Seç Sekmesi -->
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="kaynak-sec-tab"
              data-bs-toggle="tab"
              data-bs-target="#kaynakSec"
              type="button"
              role="tab"
              aria-controls="kaynakSec"
              aria-selected="false">
              Kaynak Seç
            </button>
          </li>
        </ul>

        <div class="tab-content mt-3" id="kaynakTabContent">

          <!-- (1) Kaynak Ekle Sekmesi -->
          <div 
            class="tab-pane fade show active"
            id="kaynakEkle"
            role="tabpanel"
            aria-labelledby="kaynak-ekle-tab">
            
            <!-- Bu formu AJAX ile create_reference endpoint’ine POST yapacağız -->
            <form id="kaynakForm">
              {% csrf_token %}
              <div class="mb-3">
                <label for="id_author_surname" class="form-label">Yazar Soyadı</label>
                <input 
                  type="text" 
                  class="form-control" 
                  name="author_surname" 
                  id="id_author_surname" 
                  required>
              </div>

              <div class="mb-3">
                <label for="id_author_name" class="form-label">Yazar Adı</label>
                <input 
                  type="text" 
                  class="form-control" 
                  name="author_name" 
                  id="id_author_name" 
                  required>
              </div>

              <div class="mb-3">
                <label for="id_year" class="form-label">Yıl</label>
                <input 
                  type="number" 
                  class="form-control" 
                  name="year" 
                  id="id_year" 
                  required>
              </div>
              
              <div class="mb-3">
                <label for="id_metin_ismi" class="form-label">Metin İsmi (Opsiyonel)</label>
                <input type="text" class="form-control" name="metin_ismi" id="id_metin_ismi">
              </div>

              <div class="mb-3">
                <label for="id_rest" class="form-label">Ek Bilgiler</label>
                <textarea 
                  class="form-control" 
                  name="rest" 
                  id="id_rest" 
                  rows="2"></textarea>
              </div>

              <div class="mb-3">
                <label for="id_abbreviation" class="form-label">Kısaltma (Opsiyonel)</label>
                <input 
                  type="text" 
                  class="form-control" 
                  name="abbreviation" 
                  id="id_abbreviation">
              </div>

              <button type="submit" class="btn btn-primary">Kaydet</button>
            </form>
          </div>

          <!-- (2) Kaynak Seç Sekmesi -->
          <div 
            class="tab-pane fade"
            id="kaynakSec"
            role="tabpanel"
            aria-labelledby="kaynak-sec-tab">
            
            <!-- ARAMA KUTUSU -->
            <div class="mb-3">
              <label for="kaynakAraInput" class="form-label">Arama</label>
              <input 
                type="text" 
                class="form-control" 
                id="kaynakAraInput" 
                placeholder="Arama...">
            </div>

            <!-- Arama Sonuçları (List Group) -->
            <div class="list-group" id="kaynakListesi"></div>

            <div class="mb-3">
              <label for="kaynakSayfaInput" class="form-label">Sayfa Numarası (Opsiyonel)</label>
              <input type="text" class="form-control" id="kaynakSayfaInput" placeholder="Sayfa numarası">
            </div>
            <!-- Seçili Kaynağı Metne Ekle -->
            <button 
              type="button" 
              class="btn btn-primary mt-2" 
              id="seciliKaynakEkleBtn">
              Seçileni Ekle
            </button>
          </div><!-- /tab-pane -->
        </div><!-- /tab-content -->
      </div><!-- /modal-body -->
    </div><!-- /modal-content -->
  </div><!-- /modal-dialog -->
</div><!-- /modal fade -->


<!-- SCRIPTS: Kaynak Ekle + Arama + (kaynak:ID) ekle -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Elemanları seç
      const kaynakEkleTab    = document.getElementById('kaynak-ekle-tab');
      const kaynakSecTab     = document.getElementById('kaynak-sec-tab');
      const kaynakForm       = document.getElementById('kaynakForm');
      const kaynakAraInput   = document.getElementById('kaynakAraInput');
      const kaynakListesi    = document.getElementById('kaynakListesi');
      const sayfaInput       = document.getElementById('kaynakSayfaInput');
      const modalId          = 'kaynakRefModal';
  
      // =========================
      // (1) KAYNAK OLUŞTURMA
      // =========================
      if (kaynakForm) {
          kaynakForm.addEventListener('submit', function(e) {
              e.preventDefault();
              let formData = new FormData(kaynakForm);
              fetch("{% url 'create_reference' %}", {
                  method: 'POST',
                  body: formData,
                  headers: {
                      'X-CSRFToken': "{{ csrf_token }}",
                  },
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      alert("Kaynak başarıyla eklendi!");
                      kaynakForm.reset();
                      if (kaynakSecTab) kaynakSecTab.click();
                      kaynaklariListele('');
                  } else {
                      alert("Kaynak eklenirken hata:\n" + JSON.stringify(data.errors));
                  }
              })
              .catch(err => {
                  alert("Bir hata oluştu.");
              });
          });
      }
  
      // =========================
      // (2) KAYNAK ARA/SEÇ
      // =========================
      function kaynaklariListele(searchTerm='') {
          const url = "{% url 'get_references' %}?q=" + encodeURIComponent(searchTerm);
          fetch(url)
          .then(response => response.json())
          .then(data => {
              kaynakListesi.innerHTML = '';
              data.references.forEach(ref => {
                  let label = document.createElement('label');
                  label.classList.add('list-group-item');
                  label.innerHTML = `
                      <input type="radio" name="kaynakSecimi" value="${ref.id}" class="form-check-input me-2" />
                      <span>${ref.display}</span>
                  `;
                  kaynakListesi.appendChild(label);
              });
          })
          .catch(err => {
              alert("Kaynak listesi yüklenirken hata oluştu.");
          });
      }
  
      // "Kaynak Seç" sekmesine tıklanınca arama kutusunu temizle ve tümünü getir
      if (kaynakSecTab) {
          kaynakSecTab.addEventListener('click', function() {
              if (kaynakAraInput) kaynakAraInput.value = '';
              kaynaklariListele('');
          });
      }
  
      // Arama kutusunda yazıldıkça filtrele
      if (kaynakAraInput) {
          kaynakAraInput.addEventListener('input', function() {
              let searchTerm = kaynakAraInput.value.trim();
              kaynaklariListele(searchTerm);
          });
      }
  
      // =========================
      // (3) SEÇİLEN KAYNAĞI METNE EKLE
      // =========================
      // --- Her açılışta çift event olmaması için butonu klonla/bağla ---
      function bindKaynakBtn() {
          // En güncel butonu bul
          const oldBtn = document.getElementById('seciliKaynakEkleBtn');
          if (!oldBtn) return;
  
          // Klonla ve eski eventleri temizle
          const newBtn = oldBtn.cloneNode(true);
          oldBtn.parentNode.replaceChild(newBtn, oldBtn);
  
          newBtn.addEventListener('click', function() {
              const secili = document.querySelector('input[name="kaynakSecimi"]:checked');
              if (!secili) {
                  alert("Lütfen bir kaynak seçin.");
                  return;
              }
              const refId = secili.value;
              const sayfaInput = document.getElementById('kaynakSayfaInput');
              let sayfaStr = sayfaInput ? sayfaInput.value.trim() : '';
  
              // Yanıt textarea'sı
              const answerTextArea = document.getElementById('id_answer_text');
              if (!answerTextArea) {
                  alert("Yanıt metin alanı (#id_answer_text) bulunamadı!");
                  return;
              }
              let ekMetin = sayfaStr ? ` (kaynak:${refId}, sayfa:${sayfaStr}) ` : ` (kaynak:${refId}) `;
  
              // İmleçte ekle (seçim varsa seçilen kısmı değiştir)
              if (typeof answerTextArea.selectionStart === 'number') {
                  const start = answerTextArea.selectionStart;
                  const end = answerTextArea.selectionEnd;
                  const val = answerTextArea.value;
                  answerTextArea.value = val.slice(0, start) + ekMetin + val.slice(end);
                  // İmleci eklenen bloğun sonuna taşı
                  const caret = start + ekMetin.length;
                  answerTextArea.selectionStart = answerTextArea.selectionEnd = caret;
              } else {
                  answerTextArea.value += ekMetin;
              }
  
              // Modalı kapat
              const myModal = bootstrap.Modal.getInstance(document.getElementById(modalId));
              if (myModal) myModal.hide();
          });
      }
  
      // Sayfa ilk açıldığında ve modal her açıldığında butonu bind et
      bindKaynakBtn();
  
      // Modal her gösterildiğinde tekrar bind et (çift event önler)
      const kaynakRefModal = document.getElementById(modalId);
      if (kaynakRefModal) {
          kaynakRefModal.addEventListener('shown.bs.modal', bindKaynakBtn);
      }
      // Kaynak sekmesine geçince de tekrar bind et (her ihtimale karşı)
      if (kaynakSecTab) {
          kaynakSecTab.addEventListener('click', bindKaynakBtn);
      }
  });
  </script>
  