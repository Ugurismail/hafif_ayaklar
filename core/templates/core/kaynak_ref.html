<!-- core/kaynak_ref.html -->
<div class="modal fade" id="kaynakRefModal" tabindex="-1" aria-labelledby="kaynakRefModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- Modal Başlık -->
      <div class="modal-header">
        <h5 class="modal-title" id="kaynakRefModalLabel">Kaynak İşlemleri</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <!-- Modal İçeriği (Sekmeler) -->
      <div class="modal-body">
        <ul class="nav nav-tabs" id="kaynakTab" role="tablist">
          <!-- Kaynak Ekle Sekmesi -->
          <li class="nav-item" role="presentation">
            <button 
              class="nav-link active"
              id="kaynak-ekle-tab"
              data-bs-toggle="tab"
              data-bs-target="#kaynakEkle"
              type="button" 
              role="tab"
              aria-controls="kaynakEkle"
              aria-selected="true">
              Kaynak Ekle
            </button>
          </li>

          <!-- Kaynak Seç Sekmesi -->
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="kaynak-sec-tab"
              data-bs-toggle="tab"
              data-bs-target="#kaynakSec"
              type="button"
              role="tab"
              aria-controls="kaynakSec"
              aria-selected="false">
              Kaynak Seç
            </button>
          </li>
        </ul>

        <div class="tab-content mt-3" id="kaynakTabContent">

          <!-- (1) Kaynak Ekle Sekmesi -->
          <div 
            class="tab-pane fade show active"
            id="kaynakEkle"
            role="tabpanel"
            aria-labelledby="kaynak-ekle-tab">
            
            <!-- Bu formu AJAX ile create_reference endpoint'ine POST yapacağız -->
            <form id="kaynakForm">
              {% csrf_token %}

              <!-- Yazar Konteynerı -->
              <div id="authorsContainer">
                <div class="author-group mb-3">
                  <label class="form-label">Yazar 1</label>
                  <div class="row">
                    <div class="col-md-6">
                      <input
                        type="text"
                        class="form-control author-surname"
                        placeholder="Soyadı"
                        required>
                    </div>
                    <div class="col-md-6">
                      <input
                        type="text"
                        class="form-control author-name"
                        placeholder="Adı"
                        required>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Yazar Ekle Butonu -->
              <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="addAuthorBtn">
                <i class="bi bi-plus-circle"></i> Yazar Ekle
              </button>

              <!-- Hidden fields that will be populated before submit -->
              <input type="hidden" name="author_surname" id="id_author_surname">
              <input type="hidden" name="author_name" id="id_author_name">

              <div class="mb-3">
                <label for="id_year" class="form-label">Yıl</label>
                <input 
                  type="number" 
                  class="form-control" 
                  name="year" 
                  id="id_year" 
                  required>
              </div>
              
              <div class="mb-3">
                <label for="id_metin_ismi" class="form-label">Metin İsmi</label>
                <input type="text" class="form-control" name="metin_ismi" id="id_metin_ismi">
              </div>

              <div class="mb-3">
                <label for="id_rest" class="form-label">Ek Bilgiler</label>
                <textarea 
                  class="form-control" 
                  name="rest" 
                  id="id_rest" 
                  rows="2"></textarea>
              </div>

              <div class="mb-3">
                <label for="id_abbreviation" class="form-label">Kısaltma (Opsiyonel)</label>
                <input 
                  type="text" 
                  class="form-control" 
                  name="abbreviation" 
                  id="id_abbreviation">
              </div>

              <button type="submit" class="btn btn-primary">Kaydet</button>
            </form>
          </div>

          <!-- (2) Kaynak Seç Sekmesi -->
          <div 
            class="tab-pane fade"
            id="kaynakSec"
            role="tabpanel"
            aria-labelledby="kaynak-sec-tab">
            
            <!-- ARAMA KUTUSU -->
            <div class="mb-3">
              <label for="kaynakAraInput" class="form-label">Arama</label>
              <input 
                type="text" 
                class="form-control" 
                id="kaynakAraInput" 
                placeholder="Arama...">
            </div>

            <!-- Arama Sonuçları (List Group) -->
            <div class="list-group" id="kaynakListesi" style="max-height: 400px; overflow-y: auto;"></div>

            <!-- Sayfalama için container -->
            <div id="kaynak-pagination-container"></div>

            <div class="mb-3">
              <label for="kaynakSayfaInput" class="form-label">Sayfa Numarası (Opsiyonel)</label>
              <input type="text" class="form-control" id="kaynakSayfaInput" placeholder="Sayfa numarası">
            </div>
            <!-- Seçili Kaynağı Metne Ekle -->
            <button 
              type="button" 
              class="btn btn-primary mt-2" 
              id="seciliKaynakEkleBtn">
              Seçileni Ekle
            </button>
          </div><!-- /tab-pane -->
        </div><!-- /tab-content -->
      </div><!-- /modal-body -->
    </div><!-- /modal-content -->
  </div><!-- /modal-dialog -->
</div><!-- /modal fade -->


<!-- SCRIPTS: Kaynak Ekle + Arama + (kaynak:ID) ekle -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- DOM seçiciler ---
    const kaynakEkleTab  = document.getElementById('kaynak-ekle-tab');
    const kaynakSecTab   = document.getElementById('kaynak-sec-tab');
    const kaynakForm     = document.getElementById('kaynakForm');
    const kaynakAraInput = document.getElementById('kaynakAraInput');
    const kaynakListesi  = document.getElementById('kaynakListesi');
    const sayfaInput     = document.getElementById('kaynakSayfaInput');
    const modalId        = 'kaynakRefModal';
    const kaynakRefModal = document.getElementById(modalId);

    // -----------------------
    // Kaynakları AJAX ile getir ve listele
    // -----------------------
    function kaynaklariListele(searchTerm = '', page = 1, pageSize = 5) {
        const url = "{% url 'get_references' %}?q=" + encodeURIComponent(searchTerm) + "&page=" + page + "&page_size=" + pageSize;
        fetch(url)
        .then(response => response.json())
        .then(data => {
            kaynakListesi.innerHTML = '';
            // Kaynaklar
            data.references.forEach(ref => {
                let label = document.createElement('label');
                label.classList.add('list-group-item');
                label.innerHTML = `
                    <input type="radio" name="kaynakSecimi" value="${ref.id}" class="form-check-input me-2" />
                    <span style="white-space: normal; word-break: break-word;">${ref.display}</span>
                `;
                kaynakListesi.appendChild(label);
            });

            // Pagination container'ı bul
            const pagContainer = document.getElementById('kaynak-pagination-container');

            // Pagination (varsa önce temizle, sonra ekle)
            if (pagContainer) {
                pagContainer.innerHTML = '';

                if (data.num_pages > 1) {
                    let pagHtml = `<nav id="kaynak-pagination"><ul class="pagination pagination-sm justify-content-center mt-3">`;

                    // Previous button
                    pagHtml += data.has_previous ?
                        `<li class="page-item"><a class="page-link" href="#" data-page="${data.current_page-1}">«</a></li>` :
                        `<li class="page-item disabled"><span class="page-link">«</span></li>`;

                    // Smart pagination logic
                    const current = data.current_page;
                    const total = data.num_pages;
                    const delta = 2; // Aktif sayfanın her yanında kaç sayfa gösterelim

                    // İlk sayfa her zaman
                    if (current > delta + 2) {
                        pagHtml += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
                        if (current > delta + 3) {
                            pagHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                    }

                    // Aktif sayfanın etrafındaki sayfalar
                    const start = Math.max(1, current - delta);
                    const end = Math.min(total, current + delta);

                    for (let i = start; i <= end; i++) {
                        pagHtml += `<li class="page-item${i === current ? ' active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>`;
                    }

                    // Son sayfa her zaman
                    if (current < total - delta - 1) {
                        if (current < total - delta - 2) {
                            pagHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                        pagHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${total}">${total}</a></li>`;
                    }

                    // Next button
                    pagHtml += data.has_next ?
                        `<li class="page-item"><a class="page-link" href="#" data-page="${data.current_page+1}">»</a></li>` :
                        `<li class="page-item disabled"><span class="page-link">»</span></li>`;

                    pagHtml += `</ul></nav>`;
                    pagContainer.innerHTML = pagHtml;

                    // Pagination click
                    document.querySelectorAll('#kaynak-pagination .page-link').forEach(el => {
                        el.addEventListener('click', function(e) {
                            e.preventDefault();
                            const gotoPage = parseInt(this.getAttribute('data-page'));
                            if (!isNaN(gotoPage)) {
                                kaynaklariListele(searchTerm, gotoPage, pageSize);
                            }
                        });
                    });
                }
            }
        })
        .catch(err => {
            kaynakListesi.innerHTML = '<div class="text-theme-danger">Kaynaklar yüklenemedi.</div>';
        });
    }

    // -----------------------
    // (1) Kaynak Ekleme
    // -----------------------

    // Yazar ekleme/silme işlemleri
    const authorsContainer = document.getElementById('authorsContainer');
    const addAuthorBtn = document.getElementById('addAuthorBtn');
    let authorCount = 1;

    if (addAuthorBtn) {
        addAuthorBtn.addEventListener('click', function() {
            authorCount++;
            const newAuthorGroup = document.createElement('div');
            newAuthorGroup.className = 'author-group mb-3';
            newAuthorGroup.innerHTML = `
                <label class="form-label">Yazar ${authorCount}</label>
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" class="form-control author-surname" placeholder="Soyadı" required>
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control author-name" placeholder="Adı" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-author-btn" title="Yazarı Sil">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            authorsContainer.appendChild(newAuthorGroup);

            // Silme butonuna event listener ekle
            const removeBtn = newAuthorGroup.querySelector('.remove-author-btn');
            removeBtn.addEventListener('click', function() {
                newAuthorGroup.remove();
                // Yazar numaralarını güncelle
                updateAuthorLabels();
            });
        });
    }

    function updateAuthorLabels() {
        const authorGroups = authorsContainer.querySelectorAll('.author-group');
        authorGroups.forEach((group, index) => {
            const label = group.querySelector('label');
            if (label) {
                label.textContent = `Yazar ${index + 1}`;
            }
        });
        authorCount = authorGroups.length;
    }

    if (kaynakForm) {
        kaynakForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Tüm yazarları topla ve birleştir
            const surnames = [];
            const names = [];
            const authorGroups = authorsContainer.querySelectorAll('.author-group');

            authorGroups.forEach(group => {
                const surname = group.querySelector('.author-surname').value.trim();
                const name = group.querySelector('.author-name').value.trim();
                if (surname && name) {
                    surnames.push(surname);
                    names.push(name);
                }
            });

            // Hidden fieldları doldur (semicolon ile ayır)
            document.getElementById('id_author_surname').value = surnames.join('; ');
            document.getElementById('id_author_name').value = names.join('; ');

            let formData = new FormData(kaynakForm);
            fetch("{% url 'create_reference' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': "{{ csrf_token }}",
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast("Kaynak başarıyla eklendi!", 'success');
                    kaynakForm.reset();

                    // Yazar alanlarını resetle (sadece ilk yazar grubu kalacak)
                    const allAuthorGroups = authorsContainer.querySelectorAll('.author-group');
                    allAuthorGroups.forEach((group, index) => {
                        if (index > 0) {
                            group.remove();
                        } else {
                            // İlk grup inputlarını temizle
                            group.querySelector('.author-surname').value = '';
                            group.querySelector('.author-name').value = '';
                        }
                    });
                    authorCount = 1;
                    updateAuthorLabels();

                    // Kaynak Seç sekmesine geç ve kaynakları ilk sayfadan göster
                    if (kaynakSecTab) kaynakSecTab.click();
                    if (kaynakAraInput) kaynakAraInput.value = '';
                    kaynaklariListele('', 1);
                } else {
                    showToast("Kaynak eklenirken hata:\n" + JSON.stringify(data.errors), 'error');
                }
            })
            .catch(err => {
                showToast("Bir hata oluştu.", 'error');
            });
        });
    }

    // -----------------------
    // (2) Kaynak Ara/Seç sekmesi işlevleri
    // -----------------------
    // Kaynak Seç sekmesine geçilirse (her zaman ilk sayfadan, boş aramayla başlat)
    if (kaynakSecTab) {
        kaynakSecTab.addEventListener('click', function() {
            if (kaynakAraInput) kaynakAraInput.value = '';
            kaynaklariListele('', 1);
        });
    }

    // Modal ilk açıldığında Kaynak Seç sekmesi aktifse yine yükle
    if (kaynakRefModal) {
        kaynakRefModal.addEventListener('shown.bs.modal', function() {
            if (kaynakSecTab && kaynakSecTab.classList.contains('active')) {
                if (kaynakAraInput) kaynakAraInput.value = '';
                kaynaklariListele('', 1);
            }
        });
    }

    // Arama kutusunda yazdıkça filtrele (her zaman ilk sayfa)
    if (kaynakAraInput) {
        kaynakAraInput.addEventListener('input', function() {
            let searchTerm = kaynakAraInput.value.trim();
            kaynaklariListele(searchTerm, 1);
        });
    }

    // -----------------------
    // (3) Seçili Kaynağı Metne Ekle
    // -----------------------
    function bindKaynakBtn() {
        const oldBtn = document.getElementById('seciliKaynakEkleBtn');
        if (!oldBtn) return;
        const newBtn = oldBtn.cloneNode(true);
        oldBtn.parentNode.replaceChild(newBtn, oldBtn);

        newBtn.addEventListener('click', function() {
            const secili = document.querySelector('input[name="kaynakSecimi"]:checked');
            if (!secili) {
                showToast("Lütfen bir kaynak seçin.", 'warning');
                return;
            }
            const refId = secili.value;
            let sayfaStr = sayfaInput ? sayfaInput.value.trim() : '';
            const answerTextArea = document.getElementById('id_answer_text');
            if (!answerTextArea) {
                showToast("Yanıt metin alanı (#id_answer_text) bulunamadı!", 'error');
                return;
            }
            let ekMetin = sayfaStr ? ` (kaynak:${refId}, sayfa:${sayfaStr}) ` : ` (kaynak:${refId}) `;
            // İmleçte ekle (seçim varsa seçilen kısmı değiştir)
            if (typeof answerTextArea.selectionStart === 'number') {
                const start = answerTextArea.selectionStart;
                const end = answerTextArea.selectionEnd;
                const val = answerTextArea.value;
                answerTextArea.value = val.slice(0, start) + ekMetin + val.slice(end);
                const caret = start + ekMetin.length;
                answerTextArea.selectionStart = answerTextArea.selectionEnd = caret;
            } else {
                answerTextArea.value += ekMetin;
            }
            // Modalı kapat
            const myModal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (myModal) myModal.hide();
        });
    }

    // Butonları her açılışta bind et
    bindKaynakBtn();
    if (kaynakRefModal) {
        kaynakRefModal.addEventListener('shown.bs.modal', bindKaynakBtn);
    }
    if (kaynakSecTab) {
        kaynakSecTab.addEventListener('click', bindKaynakBtn);
    }
});

</script>
  