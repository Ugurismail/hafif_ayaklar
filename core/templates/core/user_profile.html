{% extends 'core/base.html' %}
{% load static %}
{% load instance_of %}
{% load custom_tags %}
{% load markdownify %}

{% block title %}{{ profile_user.username }} - Kullanıcı Profili - Hafif Ayaklar{% endblock %}

{% block meta_description %}{{ profile_user.username }} kullanıcısının Hafif Ayaklar profili. {{ follower_count }} takipçi, {{ following_count }} takip. {% if user_profile.bio %}{{ user_profile.bio|striptags|truncatewords:30 }}{% endif %}{% endblock %}

{% block meta_keywords %}{{ profile_user.username }}, kullanıcı profili, takipçiler, soru cevap{% endblock %}

{% block canonical_url %}{{ request.scheme }}://{{ request.get_host }}/profile/{{ profile_user.username }}/{% endblock %}

{% block og_type %}profile{% endblock %}
{% block og_title %}{{ profile_user.username }} - Hafif Ayaklar{% endblock %}
{% block og_description %}{{ profile_user.username }} kullanıcısının profili. {{ follower_count }} takipçi, {{ following_count }} takip.{% endblock %}
{% block og_url %}{{ request.scheme }}://{{ request.get_host }}/profile/{{ profile_user.username }}/{% endblock %}
{% if has_profile_photo %}
{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{{ profile_photo_url }}{% endblock %}
{% endif %}

{% block twitter_title %}{{ profile_user.username }} - Hafif Ayaklar{% endblock %}
{% block twitter_description %}{{ profile_user.username }} kullanıcısının profili. {{ follower_count }} takipçi.{% endblock %}

{% block ai_structured_data %}
<!-- JSON-LD Structured Data for User Profile -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ProfilePage",
  "mainEntity": {
    "@type": "Person",
    "name": "{{ profile_user.username|escapejs }}",
    "url": "{{ request.scheme }}://{{ request.get_host }}/profile/{{ profile_user.username }}/",
    {% if has_profile_photo %}"image": "{{ request.scheme }}://{{ request.get_host }}{{ profile_photo_url }}",{% endif %}
    {% if user_profile.bio %}"description": "{{ user_profile.bio|striptags|escapejs }}",{% endif %}
    "interactionStatistic": [
      {
        "@type": "InteractionCounter",
        "interactionType": "https://schema.org/FollowAction",
        "userInteractionCount": {{ follower_count }}
      }
    ]
  }
}
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- Sol Panel: Profil Kartı -->
    <div class="col-md-3 mb-4 profile-sidebar">
      <div class="card border-0 shadow-medium">
        <div class="card-body text-center">
          <div class="profile-photo-wrapper mb-3">
            {% if has_profile_photo %}
              <img src="{{ profile_photo_url }}" alt="Profil Fotoğrafı" class="rounded-circle img-fluid" style="max-width:150px;">
            {% else %}
              <img src="{% static 'imgs/default_profile.jpg' %}" alt="Profil Fotoğrafı" class="rounded-circle img-fluid" style="max-width:150px;">
            {% endif %}
          </div>
          <h4 class="card-title mb-3">{{ profile_user.username }}</h4>
          <div class="follower-stats mb-3">
            <span class="stat-badge"><strong>{{ follower_count }}</strong> Takipçi</span>
            <span class="stat-badge"><strong>{{ following_count }}</strong> Takip</span>
          </div>
          <hr>
          {% if is_own_profile %}
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-outline-theme-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#profilePhotoModal">
                Profil Fotosunu Güncelle
              </button>
              <a href="{% url 'password_change' %}" class="btn btn-outline-theme-secondary btn-sm">Şifreyi Değiştir</a>
              <a href="{% url 'user_settings' %}" class="btn btn-outline-theme-secondary btn-sm">Ayarlar</a>
              <button type="button" class="btn btn-outline-theme-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#downloadEntriesModal">
                <i class="bi bi-download"></i> Entry'lerimi İndir
              </button>
            </div>
          {% else %}
            {% if request.user.is_authenticated %}
              {% if is_following %}
                <form action="{% url 'unfollow_user' profile_user.username %}" method="post" class="mb-2">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-theme-secondary btn-sm w-100">Takibi Bırak</button>
                </form>
              {% else %}
                <form action="{% url 'follow_user' profile_user.username %}" method="post" class="mb-2">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-theme-secondary btn-sm w-100">Takip Et</button>
                </form>
              {% endif %}
              <a href="{% url 'message_detail' profile_user.username %}" class="btn btn-outline-theme-secondary btn-sm w-100">Mesaj Gönder</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Sağ Panel: Profil Sekmeleri -->
    <div class="col-md-9 profile-content">
      {% if pinned_entry and pinned_entry.answer %}
      <div class="card mb-4 shadow-medium pinned-entry">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <a href="{% url 'question_detail' pinned_entry.answer.question.slug %}" class="text-decoration-none">
              {{ pinned_entry.answer.question.question_text }}
            </a>
          </h6>
        </div>
        <div class="card-body">
          {% if pinned_entry.answer.answer_text|length > 500 %}
            <div id="answer-summary-{{ pinned_entry.answer.id }}" class="mb-2">
              {{ pinned_entry.answer.answer_text|slice:":500"|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}...
            </div>
            <div id="answer-full-{{ pinned_entry.answer.id }}" class="mb-2" style="display: none;">
              {{ pinned_entry.answer.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}
            </div>
            <a href="#" class="read-more" data-answer-id="{{ pinned_entry.answer.id }}">Tümünü Göster</a>
          {% else %}
            <div>
              {{ pinned_entry.answer.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}
            </div>
          {% endif %}
        </div>
        {% if is_own_profile %}
        <div class="card-footer text-end">
          <form action="{% url 'unpin_entry' %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-theme-secondary">Sabitlenmiş Girdiyi Kaldır</button>
          </form>
        </div>
        {% endif %}
      </div>
      {% else %}
        <p class="mb-4">Sabitlenmiş içerik bulunamadı.</p>
      {% endif %}
      
      <!-- Sekme Menüsü -->
      <ul class="nav nav-tabs" id="profileTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'girdiler' %}active{% endif %}" 
             href="?tab=girdiler">
            Girdiler
          </a>
        </li>
        {% if is_own_profile %}
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'davetler' %}active{% endif %}" 
             href="?tab=davetler">
            Davetler
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'davet_aagac' %}active{% endif %}" 
             href="?tab=davet_aagac">
            Davet Ağacı
          </a>
        </li>
        {% endif %}
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'kelimeler' %}active{% endif %}" 
             href="?tab=kelimeler">
            Kelimeler
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'istatistikler' %}active{% endif %}" 
             href="?tab=istatistikler">
            İstatistikler
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'tanimlar' %}active{% endif %}" 
             href="?tab=tanimlar">
            Tanımlarım
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'kaynaklarim' %}active{% endif %}" 
             href="?tab=kaynaklarim">
            Kaynaklarım
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'kaydedilenler' %}active{% endif %}" 
             href="?tab=kaydedilenler">
            Kaydedilenler
          </a>
        </li>
      </ul>
      
      
      <!-- Sekme İçerikleri -->
      <div class="tab-content p-3 border border-top-0" id="profileTabContent">
        <!-- Sorular Sekmesi -->

        {% if is_own_profile %}
        <!-- Davetler Sekmesi -->
        <div class="tab-pane fade {% if active_tab == 'davetler' %}show active{% endif %}" id="davetler" role="tabpanel" aria-labelledby="davetler-tab">
          <div class="mt-3">
            <h5>Davetlerim</h5>
            <p>Gönderilen Davetiye Sayısı: {{ total_invitations }}</p>
            <p>Kullanılan Davetiye Sayısı: {{ used_invitations }}</p>
            <p>Kalan Davetiye Sayısı: {{ remaining_invitations }}</p>
            {% if remaining_invitations > 0 %}
              <form action="?tab=davetler" method="post" class="mb-3">
                {% csrf_token %}
                <div class="input-group">
                  <input type="number" name="quota_granted" min="1" max="{{ remaining_invitations }}" value="1" class="form-control" style="max-width:100px;" required>
                  <button type="submit" class="btn btn-theme-primary btn-sm">Davetiye Oluştur</button>
                </div>
              </form>
            {% else %}
              <p>Davetiye kotanız dolmuştur.</p>
            {% endif %}
            <table class="table table-sm custom-table">
              <thead>
                <tr>
                  <th>Kod</th>
                  <th>Gönderildiği Tarih</th>
                  <th>Verilen Kota</th>
                  <th>Kullanıldı mı?</th>
                  <th>Kullanan Kullanıcı</th>
                </tr>
              </thead>
              <tbody>
                {% for invite in invitations %}
                  <tr>
                    <td>{{ invite.code }}</td>
                    <td>{{ invite.created_at|date:"d M Y H:i" }}</td>
                    <td>{{ invite.quota_granted }}</td>
                    <td>{% if invite.is_used %}Evet{% else %}Hayır{% endif %}</td>
                    <td>{% if invite.used_by %}{{ invite.used_by.username }}{% else %}-{% endif %}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="5">Henüz davetiye gönderilmedi.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Davet Ağaç Sekmesi -->
        <div class="tab-pane fade {% if active_tab == 'davet_aagac' %}show active{% endif %}" id="davet_aagac" role="tabpanel" aria-labelledby="davet-aagac-tab">
          <h5>Davet Ağacı</h5>
          {% if invitation_tree %}
            <div class="invitation-tree">
              <ul class="list-unstyled">
                {% for node in invitation_tree %}
                  {% include 'core/invitation_node.html' with node=node %}
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <p>Henüz davetiye gönderilmedi.</p>
          {% endif %}
        </div>
        {% endif %}
        
        <div class="tab-pane fade {% if active_tab == 'girdiler' %}show active{% endif %}" id="girdiler" role="tabpanel" aria-labelledby="girdiler-tab">
          <div class="mt-3">
            <div class="mb-3">
              <input type="text" id="answersSearchInput" class="form-control" placeholder="Yanıt/başlık içinde ara...">
            </div>
            <div id="answersList">
              {% for answer in answers %}
                <div class="card mb-3 shadow-subtle border-0 answer-card answer" data-answer-id="{{ answer.id }}">
                  <div class="card-body">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                      <div>
                        <a href="{% url 'single_answer' answer.question.slug answer.id %}" class="fw-bold text-decoration-none question-title">
                          {{ answer.question.question_text }}
                        </a>
                        <span class="text-muted ms-2 small answer-date">({{ answer.created_at|date:"d M Y H:i" }})</span>
                      </div>
                      {% if answer.user == request.user %}
                        <button type="button" class="btn btn-sm btn-outline-theme-secondary delete-answer-btn"
                                data-answer-id="{{ answer.id }}">
                          Sil
                        </button>
                      {% endif %}
                    </div>
                    <div class="mt-2 answer-text">
                      {% if answer.answer_text|length > 1000 %}
                        <div id="answer-summary-profile-{{ answer.id }}">
                          {{ answer.answer_text|slice:":1000"|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }} ...
                        </div>
                        <div id="answer-full-profile-{{ answer.id }}" style="display: none;">
                          {{ answer.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}
                        </div>
                        <a href="#" class="read-more" data-answer-id="profile-{{ answer.id }}">Tümünü Göster</a>
                      {% else %}
                        {{ answer.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% empty %}
                <p>Henüz girdiniz yok.</p>
              {% endfor %}
            </div>
            {% if answers and answers.paginator.num_pages > 1 %}
              <nav aria-label="Girdiler Sayfaları">
                <ul class="pagination custom-pagination">
                  {% if answers.has_previous %}
                    <li class="page-item">
                      <a class="page-link" href="?answer_page={{ answers.previous_page_number }}&tab=girdiler" aria-label="Önceki">&laquo;</a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                  {% endif %}
                  <li class="page-item">
                    <select class="form-select" id="answerPageSelect" style="width: auto; display: inline-block; margin-left: 5px;">
                      {% for num in answers.paginator.page_range %}
                        <option value="{{ num }}" {% if answers.number == num %} selected {% endif %}>{{ num }}</option>
                      {% endfor %}
                    </select>
                  </li>
                  {% if answers.has_next %}
                    <li class="page-item">
                      <a class="page-link" href="?answer_page={{ answers.next_page_number }}&tab=girdiler" aria-label="Sonraki">&raquo;</a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                  {% endif %}
                </ul>
              </nav>
              <script>
                document.getElementById('answerPageSelect').addEventListener('change', function() {
                  var selectedPage = this.value;
                  window.location.href = "?answer_page=" + selectedPage + "&tab=girdiler";
                });
              </script>
            {% endif %}
          </div>
        </div>
        
        
        
        <!-- Kelimeler Sekmesi -->
        <div class="tab-pane fade {% if active_tab == 'kelimeler' %}show active{% endif %}" id="kelimeler" role="tabpanel" aria-labelledby="kelimeler-tab">
          <div class="mt-3 row">
            <div class="col-md-6">
              <h5 class="mb-3">
                <i class="bi bi-bar-chart-fill"></i> En Çok Kullandığınız Kelimeler
              </h5>
              {% if top_words %}
                <ul class="word-list">
                  {% for word, count in top_words %}
                    <li>
                      <span>{{ forloop.counter }}. <strong>{{ word }}</strong></span>
                      <span class="word-count-badge">{{ count }}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="alert alert-secondary">
                  <i class="bi bi-info-circle"></i> Henüz girdi yazmadınız veya tüm kelimeler listeden çıkarıldı.
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              {% if is_own_profile %}
                <h5 class="mb-3">Kelime Arama</h5>
                <form method="get" action="">
                  <input type="hidden" name="tab" value="kelimeler">
                  <input type="hidden" name="exclude_words" value="{{ exclude_words }}">
                  <div class="input-group mb-3">
                    <input type="text" name="search_word" class="form-control" placeholder="Aramak istediğiniz kelimeyi girin..." value="{{ search_word }}">
                    <button class="btn btn-theme-primary" type="submit">
                      <i class="bi bi-search"></i> Ara
                    </button>
                  </div>
                </form>
                {% if search_word %}
                  <div class="alert alert-info py-2 mb-3">
                    <i class="bi bi-info-circle"></i> "<strong>{{ search_word }}</strong>" kelimesini <strong>{{ search_word_count }}</strong> kez kullandınız.
                  </div>
                {% endif %}

                <h5 class="mb-3 mt-4">Kelime Çıkar</h5>
                <form method="get" action="">
                  <input type="hidden" name="tab" value="kelimeler">
                  <div class="input-group mb-3">
                    <input type="text" name="exclude_words" class="form-control" placeholder="Virgülle ayırarak birden fazla kelime çıkarabilirsiniz (örn: ve, ama, için)">
                    <button class="btn btn-theme-secondary" type="submit">
                      <i class="bi bi-dash-circle"></i> Çıkar
                    </button>
                  </div>
                </form>
                <p class="text-muted small">
                  <i class="bi bi-lightbulb"></i> Virgülle ayrılmış kelimeleri girerek toplu olarak çıkarabilirsiniz. Çıkardığınız kelimeler kalıcı olarak kaydedilir ve "En Çok Kullandığınız Kelimeler" listesinde görünmeyecektir.
                </p>
              {% endif %}
              <h5 class="mt-4">Çıkarılmış Kelimeler</h5>
              {% if is_own_profile %}
                {% if exclude_words_list %}
                  <div class="d-flex flex-wrap gap-2 mt-3">
                    {% for word in exclude_words_list %}
                      <span class="badge rounded-pill bg-secondary excluded-word-badge">
                        {{ word }}
                        <a href="?tab=kelimeler&include_word={{ word }}"
                           class="text-white text-decoration-none ms-1"
                           title="Geri Al"
                           style="opacity: 0.8;">
                          <i class="bi bi-x-circle"></i>
                        </a>
                      </span>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted">Henüz çıkarılmış kelime yok.</p>
                {% endif %}
              {% else %}
                <p class="text-muted">Bu bölümü sadece kullanıcının kendisi görebilir.</p>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- İstatistikler Sekmesi -->
        <div class="tab-pane fade {% if active_tab == 'istatistikler' %}show active{% endif %}" id="istatistikler" role="tabpanel" aria-labelledby="istatistikler-tab">
          <div class="mt-3">
            <h5 class="mb-4">İstatistikler</h5>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value">{{ total_upvotes }} / {{ total_downvotes }}</div>
                <div class="stat-label">Beğeni / Beğenmeme</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ total_entries }}</div>
                <div class="stat-label">Toplam Entry</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ total_words }}</div>
                <div class="stat-label">Toplam Kelime</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ total_chars }}</div>
                <div class="stat-label">Karakter</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ avg_words_per_entry|floatformat:1 }}</div>
                <div class="stat-label">Girdi Başına Ort. Kelime</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ total_saves }}</div>
                <div class="stat-label">Kaydedilme</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ total_references }}</div>
                <div class="stat-label">Kaynak</div>
              </div>
            </div>
            <h6>En Çok Upvote Alan Girdi:</h6>
            {% if most_upvoted_entry %}
              {% if most_upvoted_entry|instance_of:'Question' %}
                <p>Soru:
                  <a href="{% url 'question_detail' most_upvoted_entry.slug %}" class="text-decoration-none">
                    {{ most_upvoted_entry.question_text }}
                  </a>
                  ({{ most_upvoted_entry.upvotes }} upvotes)
                </p>
              {% elif most_upvoted_entry|instance_of:'Answer' %}
                <p>Yanıt:
                  <a href="{% url 'question_detail' most_upvoted_entry.question.slug %}" class="text-decoration-none">
                    {{ most_upvoted_entry.question.question_text }}
                  </a>
                  ({{ most_upvoted_entry.upvotes }} upvotes)
                </p>
              {% endif %}
            {% else %}
              <p>Henüz upvote alan bir girdi yok.</p>
            {% endif %}
            <h6>En Çok Downvote Alan Girdi:</h6>
            {% if most_downvoted_entry %}
              {% if most_downvoted_entry|instance_of:'Question' %}
                <p>Soru:
                  <a href="{% url 'question_detail' most_downvoted_entry.slug %}" class="text-decoration-none">
                    {{ most_downvoted_entry.question_text }}
                  </a>
                  ({{ most_downvoted_entry.downvotes }} downvotes)
                </p>
              {% elif most_downvoted_entry|instance_of:'Answer' %}
                <p>Yanıt:
                  <a href="{% url 'question_detail' most_downvoted_entry.question.slug %}" class="text-decoration-none">
                    {{ most_downvoted_entry.question.question_text }}
                  </a>
                  ({{ most_downvoted_entry.downvotes }} downvotes)
                </p>
              {% endif %}
            {% else %}
              <p>Henüz downvote alan bir girdi yok.</p>
            {% endif %}
            <h6>En Çok Kaydedilen Girdi:</h6>
            {% if most_saved_entry %}
              {% if most_saved_entry|instance_of:'Question' %}
                <p>Soru:
                  <a href="{% url 'question_detail' most_saved_entry.slug %}" class="text-decoration-none">
                    {{ most_saved_entry.question_text }}
                  </a>
                </p>
              {% elif most_saved_entry|instance_of:'Answer' %}
                <p>Yanıt:
                  <a href="{% url 'question_detail' most_saved_entry.question.slug %}" class="text-decoration-none">
                    {{ most_saved_entry.question.question_text }}
                  </a>
                </p>
              {% endif %}
            {% else %}
              <p>Henüz kaydedilen bir girdi yok.</p>
            {% endif %}
          </div>
        </div>
        <!-- Tanımlarım Sekmesi -->
          <div class="tab-pane fade {% if active_tab == 'tanimlar' %}show active{% endif %}" id="tanimlar" role="tabpanel" aria-labelledby="tanimlar-tab">
            <div class="mt-3">
              <h5>Tanımlarım</h5>
              <!-- Arama Formu -->
              <form method="get" action="">
                <input type="hidden" name="tab" value="tanimlar">
                <div class="input-group mb-3">
                  <input type="text" name="q" id="definitionsSearchInput" class="form-control" placeholder="Tanım arayın..." value="{{ request.GET.q }}">
                  <button type="submit" class="btn btn-theme-primary">Ara</button>
                </div>
              </form>
              <table class="table custom-table table-sm">
                <thead>
                  <tr>
                    <th>Kelime (Başlık/Soru)</th>
                    <th>Tanım İçeriği</th>
                    <th style="width: 180px;">İşlemler</th>
                  </tr>
                </thead>
                <tbody id="definitionsTbody">
                  {% for definition in definitions_page.object_list %}
                    <tr>
                      <td>
                        <a href="{% url 'question_detail' definition.question.slug %}" class="text-decoration-none">
                          {{ definition.question.question_text }}
                        </a>
                      </td>
                      <td>{{ definition.definition_text|truncatewords:25 }}</td>
                      <td>
                        {% if definition.user == user %}
                        <a href="{% url 'edit_definition' definition.id %}?tab=tanimlar" class="btn btn-sm btn-theme-primary">Düzenle</a>
                        <button type="button" class="btn btn-sm btn-theme-secondary delete-definition-btn"
                                data-definition-id="{{ definition.id }}">
                          Sil
                        </button>
                    {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% if definitions_page and definitions_page.paginator.num_pages > 1 %}
                {% include 'core/pagination.html' with page_obj=definitions_page page_param='d_page' active_tab='tanimlar' %}
              {% endif %}
            </div>
          </div>

          <!-- Kaynaklarım Sekmesi -->
          <div class="tab-pane fade {% if active_tab == 'kaynaklarim' %}show active{% endif %}" id="kaynaklarim" role="tabpanel" aria-labelledby="kaynaklarim-tab">
            <div class="mt-3">
              <h5>Kaynaklarım</h5>
              <!-- Arama Formu -->
              <form method="get" action="" id="referencesSearchForm">
                <input type="hidden" name="tab" value="kaynaklarim">
                <input type="hidden" name="sort" id="referencesSortInput" value="{{ reference_sort|default:'alpha' }}">
                <input type="hidden" name="order" id="referencesOrderInput" value="{{ reference_order|default:'asc' }}">
                <div class="input-group mb-3">
                  <input type="text" name="q" id="referencesSearchInput" class="form-control" placeholder="Kaynak arayın..." value="{{ request.GET.q }}">
                  <button class="btn btn-outline-theme-secondary" type="button" data-bs-toggle="modal" data-bs-target="#referencesSortModal" title="Sıralama">
                    <i class="bi bi-sliders"></i>
                  </button>
                  <button type="submit" class="btn btn-theme-primary">Ara</button>
                </div>
              </form>
              <div id="referencesContainer">
                {% if references_page.object_list %}
                  <table class="table custom-table">
                    <thead>
                      <tr>
                        <th>Yazar Soyadı</th>
                        <th>Yazar Adı</th>
                        <th>Yıl</th>
                        <th>Eser İsmi</th>
                        <th>Ek Bilgiler</th>
                        <th>Kullanım Sayısı</th>
                        <th>İşlemler</th>
                      </tr>
                    </thead>
                    <tbody id="referencesTbody">
                      {% for ref in references_page.object_list %}
                        <tr>
                          <td>{{ ref.author_surname }}</td>
                          <td>{{ ref.author_name }}</td>
                          <td>{{ ref.year }}</td>
                          <td>{{ ref.metin_ismi|default:"-" }}</td>
                          <td>{{ ref.rest }}</td>
                          <td>{{ ref.usage_count }}</td>
                          <td>
                            {% if ref.created_by == user %}
                            <a href="{% url 'edit_reference' ref.id %}?tab=kaynaklarim" class="btn btn-sm btn-theme-primary" title="Düzenle">
                              <i class="bi bi-pencil-square"></i>
                            </a>
                            <a href="{% url 'delete_reference' ref.id %}?tab=kaynaklarim" class="btn btn-sm btn-theme-secondary" title="Sil">
                              <i class="bi bi-trash"></i>
                            </a>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  {% if references_page and references_page.paginator.num_pages > 1 %}
                    {% include 'core/pagination.html' with page_obj=references_page page_param='r_page' active_tab='kaynaklarim' %}
                  {% endif %}
                {% else %}
                  <p>Henüz kaynak eklemediniz.</p>
                {% endif %}
              </div>
            </div>
          </div>

        <!-- kaydedilenler Sekmesi -->
        <div class="tab-pane fade {% if active_tab == 'kaydedilenler' %}show active{% endif %}" id="kaydedilenler" role="tabpanel" aria-labelledby="kaydedilenler-tab">
          <div class="mt-3">
            <h5>Kaydedilenler</h5>
            <div id="savedItemsContainer" class="mb-3">
              <input type="text" id="savedItemsSearchInput" class="form-control" placeholder="Kaydedilenler içinde ara...">
            </div>
            <div id="savedItemsList">

            
              <hr> <!-- buradan sonrası eski kodun -->
              {% if saved_items_page and saved_items_page.object_list %}
                {% for saved in saved_items_page.object_list %}
                  {% if saved.type == "question" %}
                    <div class="mb-3 p-2 border rounded">
                      <p>
                        <strong>Soru:</strong>
                        <a href="{% url 'question_detail' saved.object.slug %}" class="text-decoration-none">
                          {{ saved.object.question_text|truncatewords:20 }}
                        </a>
                      </p>
                      <a href="#" class="save-btn btn btn-sm btn-theme-primary"
                         data-content-type="question"
                         data-object-id="{{ saved.object.id }}">
                        Kaydetmeyi Kaldır
                      </a>
                    </div>
                  {% elif saved.type == "answer" %}
                    <div class="mb-3 p-2 border rounded position-relative">
                      <p>
                        <strong>Yanıt:</strong>
                        <a href="{% url 'question_detail' saved.object.question.slug %}#answer-{{ saved.object.id }}" class="text-decoration-none">
                          {{ saved.object.question.question_text|truncatewords:20 }}
                        </a>
                      </p>
                      <div class="mt-2">
                        {% if saved.object.answer_text|length > 1000 %}
                          <div id="answer-summary-saved-{{ saved.object.id }}">
                            {{ saved.object.answer_text|slice:":1000"|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }} ...
                          </div>
                          <div id="answer-full-saved-{{ saved.object.id }}" style="display: none;">
                            {{ saved.object.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}
                          </div>
                          <a href="#" class="read-more" data-answer-id="saved-{{ saved.object.id }}">Tümünü Göster</a>
                        {% else %}
                          {{ saved.object.answer_text|safe_markdownify:"default"|spoiler_link|bkz_link|tanim_link|reference_link|ref_link|mention_link }}
                        {% endif %}
                      </div>
                      <div class="position-absolute top-0 end-0 me-2 mt-2">
                        <a href="#" class="save-btn btn btn-sm btn-link icon-black-white"
                           data-content-type="answer"
                           data-object-id="{{ saved.object.id }}"
                           title="Kaydetmeyi kaldır">
                          <i class="bi bi-bookmark-x fs-5"></i>
                        </a>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% else %}
                <p>Diğer kullanıcının kaydedilenlerini göremezsiniz.</p>
              {% endif %}
            </div>
            
            {% if saved_items_page and saved_items_page.paginator.num_pages > 1 %}
              {% include 'core/pagination.html' with page_obj=saved_items_page page_param='s_page' active_tab='kaydedilenler' %}
            {% endif %}
          </div>
        </div>
        
        
      </div>
    </div>
  </div>
</div>

<!-- Kaynaklarım Sıralama Modal -->
<div class="modal fade" id="referencesSortModal" tabindex="-1" aria-labelledby="referencesSortModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-medium">
      <div class="modal-header">
        <h5 class="modal-title" id="referencesSortModalLabel">Kaynaklarım Sıralama</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="referencesSortSelect" class="form-label">Kriter</label>
          <select class="form-select" id="referencesSortSelect">
            <option value="alpha">Alfabetik</option>
            <option value="usage">Kullanım</option>
            <option value="year">Yıl</option>
            <option value="created">Eklenme</option>
          </select>
        </div>
        <div class="mb-2">
          <label for="referencesOrderSelect" class="form-label">Sıra</label>
          <select class="form-select" id="referencesOrderSelect">
            <option value="asc">Artan</option>
            <option value="desc">Azalan</option>
          </select>
        </div>
        <div class="text-muted small">
          Kullanım sıralaması, kaynakların entry’lerde kaç kez geçtiğine göre hesaplanır.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-theme-secondary" data-bs-dismiss="modal">Vazgeç</button>
        <button type="button" class="btn btn-theme-primary" id="referencesSortApplyBtn" data-bs-dismiss="modal">Uygula</button>
      </div>
    </div>
  </div>
</div>

<!-- Profil Fotoğrafı Güncelleme Modal -->
<div class="modal fade" id="profilePhotoModal" tabindex="-1" aria-labelledby="profilePhotoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" action="{% url 'update_profile_photo' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="profilePhotoModalLabel">Profil Fotoğrafını Güncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-3">
            {% if has_profile_photo %}
              <img id="current-profile-pic" src="{{ profile_photo_url }}" alt="Mevcut Fotoğraf" class="img-fluid rounded-circle" style="max-width:150px;">
            {% else %}
              <img id="current-profile-pic" src="{% static 'imgs/default_profile.jpg' %}" alt="Varsayılan Fotoğraf" class="img-fluid rounded-circle" style="max-width:150px;">
            {% endif %}
          </div>
          <div class="mb-3">
            <label for="id_photo" class="form-label">Yeni Fotoğraf Seç (opsiyonel):</label>
            <input type="file" name="photo" id="id_photo" class="form-control">
          </div>
          {% if has_profile_photo %}
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="remove_photo" value="true" id="removePhotoCheck">
            <label class="form-check-label" for="removePhotoCheck">
              Mevcut fotoğrafı kaldır (Varsayılan fotoğraf kullanılacak)
            </label>
          </div>
          {% endif %}
          <div class="text-center" id="new-photo-preview-container" style="display:none;">
            <p>Yeni Seçilen Fotoğraf Önizlemesi:</p>
            <img id="new-photo-preview" src="#" alt="Önizleme" class="img-fluid rounded-circle" style="max-width:150px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-theme-primary" data-bs-dismiss="modal">İptal</button>
          <button type="submit" class="btn btn-theme-primary">Güncelle</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Entry'leri İndir Modal -->
<div class="modal fade" id="downloadEntriesModal" tabindex="-1" aria-labelledby="downloadEntriesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downloadEntriesModalLabel">Entry'lerimi İndir</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <form id="downloadEntriesForm">
          {% csrf_token %}

          <!-- Format Seçimi -->
          <div class="mb-4">
            <label class="form-label fw-bold">İndirme Formatı</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="format" id="formatPDF" value="pdf" checked>
              <label class="btn btn-outline-theme-secondary" for="formatPDF">PDF</label>

              <input type="radio" class="btn-check" name="format" id="formatWord" value="docx">
              <label class="btn btn-outline-theme-secondary" for="formatWord">Word</label>

              <input type="radio" class="btn-check" name="format" id="formatExcel" value="xlsx">
              <label class="btn btn-outline-theme-secondary" for="formatExcel">Excel</label>

              <input type="radio" class="btn-check" name="format" id="formatJSON" value="json">
              <label class="btn btn-outline-theme-secondary" for="formatJSON">JSON</label>
            </div>
          </div>

          <!-- Tümünü İndir Checkbox -->
          <div class="mb-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="downloadAllCheckbox">
              <label class="form-check-label fw-bold" for="downloadAllCheckbox">
                Tüm entry'lerimi indir (seçim yapmadan hepsini indir)
              </label>
            </div>
          </div>

          <!-- Başlangıç Soruları Seçimi -->
          <div class="mb-4" id="rootQuestionSection">
            <label class="form-label fw-bold">Başlangıç Sorusuna Göre İndir</label>
            <p class="text-muted small mb-2">Bir başlangıç sorusu seçerek o soruya ve tüm alt sorularına yazdığınız entry'leri indirebilirsiniz.</p>
            <select class="form-select mb-2" id="rootQuestionSelect">
              <option value="">-- Başlangıç sorusu seçin (opsiyonel) --</option>
            </select>
            <small class="text-muted">Yükleniyor...</small>
          </div>

          <!-- Entry Seçimi (sadece "tümünü indir" seçili DEĞİLse göster) -->
          <div class="mb-4" id="entrySelectionSection">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label fw-bold mb-0">Entry Seçimi</label>
              <div>
                <button type="button" class="btn btn-sm btn-outline-theme-secondary" id="selectAllEntries">Tümünü Seç</button>
                <button type="button" class="btn btn-sm btn-outline-theme-secondary" id="deselectAllEntries">Hiçbirini Seçme</button>
              </div>
            </div>
            <!-- Arama -->
            <div class="mb-2">
              <input type="text" class="form-control form-control-sm" id="searchEntriesInput" placeholder="Entry'lerde ara (başlık veya metin)...">
            </div>
            <div id="entriesContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 1rem;">
              <p class="text-muted">Yükleniyor...</p>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-muted">Gösterilen: <span id="visibleCount">0</span> / Seçili: <span id="selectedCount">0</span></small>
              <button type="button" class="btn btn-sm btn-outline-theme-secondary" id="loadMoreButton" style="display: none;">
                Daha Fazla Yükle
              </button>
            </div>
          </div>

          <!-- Sıralama -->
          <div class="mb-3">
            <label class="form-label fw-bold">Sıralama</label>
            <select class="form-select" name="order" id="orderSelect">
              <option value="oldest">En Eskiden En Yeniye</option>
              <option value="newest">En Yeniden En Eskiye</option>
              <option value="custom">Özel Sıralama (Seçim Sırasına Göre)</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-theme-primary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-theme-primary" id="downloadButton">
          <i class="bi bi-download"></i> İndir
        </button>
      </div>
    </div>
  </div>
</div>

{% include 'core/link_modal.html' %}
{% include 'core/kaynak_ref.html' %}
{% include 'core/reference_modal.html' %}

{% if form and form.errors %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var modal = new bootstrap.Modal(document.getElementById('profilePhotoModal'));
  modal.show();
});
</script>
{% endif %}
{% endblock content %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/answer_form.js' %}"></script>
<script src="{% static 'js/vote_save.js' %}"></script>

<script>
  // 1. Ortak debounce fonksiyonu (çalışma sıklığını azaltmak için)
  function debounce(func, delay) {
    var timeout;
    return function() {
      var context = this, args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(function(){
        func.apply(context, args);
      }, delay);
    };
  }

  // 2. Genel AJAX arama fonksiyonu (render callback ile)
  function setupDynamicSearch(inputSelector, endpointUrl, targetSelector, renderFunction) {
    $(inputSelector).on('keyup', debounce(function(){
      var query = $(this).val();
      $.ajax({
        url: endpointUrl,
        data: { q: query },
        dataType: "json",
        success: function(data) {
          var container = $(targetSelector);
          container.empty();
          renderFunction(data, container);
        }
      });
    }, 300));
  }

  // 3. Tanımlar için render fonksiyonu
  function renderDefinitions(data, container) {
    if(data.definitions && data.definitions.length > 0) {
      // CSRF token'ı meta tag'dan alıyoruz:
      var csrfToken = $('meta[name="csrf-token"]').attr('content');
      $.each(data.definitions, function(i, def){
        var row = '<tr>'+
                    '<td>'+ def.question_text +'</td>'+
                    '<td>'+ def.definition_text +'</td>'+
                    '<td>'+
                      '<a href="/edit_definition/'+ def.id + '/?tab=tanimlar" class="btn btn-sm btn-theme-primary">Düzenle</a> '+
                      '<button type="button" class="btn btn-sm btn-theme-secondary delete-definition-btn" data-definition-id="'+ def.id +'">Sil</button>'+
                    '</td>'+
                  '</tr>';
        container.append(row);
      });
    } else {
      container.append('<tr><td colspan="3">Sonuç bulunamadı.</td></tr>');
    }
  }

  // 4. Kaynaklar için render fonksiyonu
  function renderReferences(data, container) {
    if(data.references && data.references.length > 0) {
      $.each(data.references, function(i, ref){
        var row = '<tr>'+
                    '<td>'+ ref.author_surname +'</td>'+
                    '<td>'+ ref.author_name +'</td>'+
                    '<td>'+ ref.year +'</td>'+
                    '<td>'+ (ref.metin_ismi || '-') +'</td>'+
                    '<td>'+ ref.rest +'</td>'+
                    '<td>'+(ref.usage_count || 0)+'</td>'+
                    '<td>'+
                      '<a href="/reference/'+ ref.id + '/edit/?tab=kaynaklarim" class="btn btn-sm btn-theme-primary" title="Düzenle"><i class="bi bi-pencil-square"></i></a> '+
                      '<a href="/reference/'+ ref.id + '/delete/?tab=kaynaklarim" class="btn btn-sm btn-theme-secondary" title="Sil"><i class="bi bi-trash"></i></a>'+
                    '</td>'+
                  '</tr>';
        container.append(row);
      });
    } else {
      container.append('<tr><td colspan="7">Sonuç bulunamadı.</td></tr>');
    }
  }
  
  
  function renderQuestions(data, container) {
  if (data.questions && data.questions.length > 0) {
    $.each(data.questions, function(i, question) {
      var card = `
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body">
            <a href="${question.detail_url}" class="fw-bold text-primary text-decoration-none">
              ${question.question_text}
            </a>
          </div>
        </div>
      `;
      container.append(card);
    });
  } else {
    container.append('<p>Sonuç bulunamadı.</p>');
  }
}


  // 5. Soru, yanıt ve kaydedilenler için render fonksiyonları
  function renderAnswers(data, container) {
  if (data.answers && data.answers.length > 0) {
    $.each(data.answers, function(i, answer) {
      var card = `
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
              <div>
                <a href="${answer.question_url}" class="fw-bold text-primary text-decoration-none">
                  ${answer.question_text}
                </a>
                <span class="text-muted ms-2 small">(${answer.created_at})</span>
              </div>
            </div>
            <div class="mt-2">
              <a href="${answer.detail_url}" class="text-body text-decoration-none">
                ${answer.answer_text}
              </a>
            </div>
          </div>
        </div>
      `;
      container.append(card);
    });
  } else {
    container.append('<p>Sonuç bulunamadı.</p>');
  }
}


function renderSavedItems(data, container) {
  if (data.saved_items && data.saved_items.length > 0) {
    $.each(data.saved_items, function(i, item) {
      let html = '';
      if (item.type === 'question') {
        html = `
          <div class="mb-3 p-2 border rounded card">
            <p>
              <strong>Soru:</strong>
              <a href="${item.detail_url}" class="text-decoration-none">
                ${item.text}
              </a>
            </p>
            <a href="#" class="save-btn btn btn-sm btn-theme-primary"
               data-content-type="question"
               data-object-id="${item.id}">
              Kaydetmeyi Kaldır
            </a>
          </div>
        `;
      } else if (item.type === 'answer') {
        html = `
          <div class="mb-3 p-2 border rounded position-relative card">
            <p>
              <strong>Yanıt:</strong>
              <a href="${item.question_url}#answer-${item.id}" class="text-decoration-none">
                ${item.question_text}
              </a>
            </p>
            <a href="${item.detail_url}" class="text-body text-decoration-none">
              ${item.text}
            </a>
            <div class="position-absolute top-0 end-0 me-2 mt-2">
              <a href="#" class="save-btn btn btn-sm btn-link icon-black-white"
                 data-content-type="answer"
                 data-object-id="${item.id}"
                 title="Kaydetmeyi kaldır">
                <i class="bi bi-bookmark-x fs-5"></i>
              </a>
            </div>
          </div>
        `;
      }
      container.append(html);
    });
  } else {
    container.append('<p>Sonuç bulunamadı.</p>');
  }
}


  // 6. Belirtilen inputlar için dinamik aramayı başlatıyoruz
  $(document).ready(function(){
  var profileUsername = "{{ profile_user.username }}";  // şablondan dinamik geliyor

  function getReferenceSortParams() {
    return {
      sort: ($('#referencesSortInput').val() || 'alpha'),
      order: ($('#referencesOrderInput').val() || 'asc'),
    };
  }

  function syncReferenceSortModalFromInputs() {
    var params = getReferenceSortParams();
    var sortEl = document.getElementById('referencesSortSelect');
    var orderEl = document.getElementById('referencesOrderSelect');
    if (sortEl) sortEl.value = params.sort;
    if (orderEl) orderEl.value = params.order;
  }

  // Ortak dinamik arama fonksiyonu
  function setupDynamicSearch(inputSelector, endpointUrl, targetSelector, renderFunction, tabName) {
    $(inputSelector).on('keyup', debounce(function(){
      var query = $(this).val();
      var data = { q: query };
      // Kaynaklarım sekmesi: sıralama parametrelerini de gönder
      if (inputSelector === '#referencesSearchInput') {
        var params = getReferenceSortParams();
        data.sort = params.sort;
        data.order = params.order;
      }
      $.ajax({
        url: endpointUrl,
        data: data,
        dataType: "json",
        success: function(data) {
          var container = $(targetSelector);
          container.empty();
          renderFunction(data, container);
        }
      });
    }, 300));

    // Input boşaltıldığında sekmeyi baştan yükle (tam reload ile)
    $(inputSelector).on('input', function() {
      if ($(this).val().trim() === '') {
        if (inputSelector === '#referencesSearchInput') {
          var params = getReferenceSortParams();
          var sortValue = params.sort;
          var orderValue = params.order;
          window.location.href = window.location.pathname + "?tab=" + tabName + "&sort=" + encodeURIComponent(sortValue) + "&order=" + encodeURIComponent(orderValue);
        } else {
          window.location.href = window.location.pathname + "?tab=" + tabName;
        }
      }
    });
  }

  // Kullanım: Tüm inputlar için çağır (tab adını da ver!)
  setupDynamicSearch(
    '#definitionsSearchInput',
    "{% url 'get_user_definitions' %}?username=" + profileUsername,
    '#definitionsTbody',
    renderDefinitions,
    'tanimlar'
  );
  setupDynamicSearch(
    '#referencesSearchInput',
    "{% url 'get_references' %}?username=" + profileUsername,
    '#referencesTbody',
    renderReferences,
    'kaynaklarim'
  );
  setupDynamicSearch(
    '#answersSearchInput',
    "{% url 'get_user_answers' %}?username=" + profileUsername,
    '#answersList',
    renderAnswers,
    'girdiler'
  );
  setupDynamicSearch(
    '#savedItemsSearchInput',
    "{% url 'get_saved_items' %}?username=" + profileUsername,
    '#savedItemsList',
    renderSavedItems,
    'kaydedilenler'
  );

  // Kaynaklarım sıralama modalı
  $('#referencesSortModal').on('show.bs.modal', function() {
    syncReferenceSortModalFromInputs();
  });

  $('#referencesSortApplyBtn').on('click', function() {
    var sortEl = document.getElementById('referencesSortSelect');
    var orderEl = document.getElementById('referencesOrderSelect');
    $('#referencesSortInput').val(sortEl ? sortEl.value : 'alpha');
    $('#referencesOrderInput').val(orderEl ? orderEl.value : 'asc');
    $('#referencesSearchForm').trigger('submit');
  });
});

// Debounce fonksiyonu (aynen kalacak)
function debounce(func, delay) {
  var timeout;
  return function() {
    var context = this, args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(function(){
      func.apply(context, args);
    }, delay);
  };
}

  // 7. Sekme seçim ve URL güncelleme
  document.addEventListener('DOMContentLoaded', function() {
    var params = new URLSearchParams(window.location.search);
    var initialTab = params.get('tab');
    if (initialTab) {
      var tabTriggerEl = document.querySelector('.nav-link[href="#' + initialTab + '"]');
      if (tabTriggerEl) {
        var tab = new bootstrap.Tab(tabTriggerEl);
        tab.show();
      }
    }
    var tabLinks = document.querySelectorAll('#profileTab .nav-link');
    tabLinks.forEach(function(link) {
      link.addEventListener('shown.bs.tab', function(e) {
        var href = e.target.getAttribute('href');
        var newTab = href.replace('#', '');
        var newUrl = window.location.pathname + '?tab=' + newTab;
        history.pushState({}, '', newUrl);
      });
    });
  });

  // 8. Profil fotoğrafı önizleme
  var fileInput = document.getElementById('id_photo');
  var previewContainer = document.getElementById('new-photo-preview-container');
  var previewImage = document.getElementById('new-photo-preview');
  if (fileInput) {
    fileInput.addEventListener('change', function() {
      var file = this.files[0];
      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
          previewContainer.style.display = 'block';
          previewImage.src = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        previewContainer.style.display = 'none';
        previewImage.src = '#';
      }
    });
  }

  // 9. Sabitlenmiş girdi "read-more" işlevi
  var readMoreLinks = document.querySelectorAll('.read-more');
  readMoreLinks.forEach(function(link) {
    link.addEventListener('click', function(event) {
      event.preventDefault();
      var answerId = link.getAttribute('data-answer-id');
      var summary = document.getElementById('answer-summary-' + answerId);
      var fullText = document.getElementById('answer-full-' + answerId);
      if (summary && fullText) {
        if (summary.style.display === 'none') {
          summary.style.display = 'block';
          fullText.style.display = 'none';
          link.textContent = 'Tümünü Göster';
        } else {
          summary.style.display = 'none';
          fullText.style.display = 'block';
          link.textContent = 'Daha az göster';
        }
      }
    });
  });

  // 10. Yanıt silme işlemi (modal ile)
  document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('delete-answer-btn')) {
      e.preventDefault();
      var answerId = e.target.getAttribute('data-answer-id');

      showConfirm(
        'Bu yanıtı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.',
        'Yanıtı Sil',
        'Sil',
        'btn-theme-secondary'
      ).then(function(confirmed) {
        if (confirmed) {
          // CSRF token'ı al
          var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          // Form oluştur ve gönder
          var form = document.createElement('form');
          form.method = 'POST';
          form.action = '/answer/' + answerId + '/delete/';

          var csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);

          document.body.appendChild(form);
          form.submit();
        }
      });
    }
  });

  // 11. Tanım silme işlemi (modal ile)
  document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('delete-definition-btn')) {
      e.preventDefault();
      var definitionId = e.target.getAttribute('data-definition-id');

      showConfirm(
        'Bu tanımı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.',
        'Tanımı Sil',
        'Sil',
        'btn-theme-secondary'
      ).then(function(confirmed) {
        if (confirmed) {
          // CSRF token'ı al
          var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          // Form oluştur ve gönder
          var form = document.createElement('form');
          form.method = 'POST';
          form.action = '/definition/' + definitionId + '/delete/?tab=tanimlar';

          var csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);

          document.body.appendChild(form);
          form.submit();
        }
      });
    }
  });

  // ========== ENTRY İNDİRME MODAL ==========
  const downloadModal = document.getElementById('downloadEntriesModal');
  const downloadAllCheckbox = document.getElementById('downloadAllCheckbox');
  const entrySelectionSection = document.getElementById('entrySelectionSection');
  const loadMoreButton = document.getElementById('loadMoreButton');

  let userEntries = [];
  let currentPage = 1;
  let hasMore = false;
  let totalEntries = 0;
  let currentSearchTerm = '';

  // "Tümünü İndir" checkbox değişikliğini dinle
  downloadAllCheckbox.addEventListener('change', function() {
    if (this.checked) {
      // Tümünü indir modunda: entry seçim bölümünü gizle
      entrySelectionSection.style.display = 'none';
    } else {
      // Seçerek indir modunda: entry seçim bölümünü göster
      entrySelectionSection.style.display = 'block';
    }
  });

  // Modal açıldığında
  downloadModal.addEventListener('show.bs.modal', function() {
    // Reset
    downloadAllCheckbox.checked = false;
    entrySelectionSection.style.display = 'block';
    currentPage = 1;
    userEntries = [];
    currentSearchTerm = '';
    document.getElementById('searchEntriesInput').value = '';
    document.getElementById('rootQuestionSelect').value = '';

    // Başlangıç sorularını yükle
    loadRootQuestions();

    // İlk sayfayı yükle
    loadUserEntries();
  });

  // Başlangıç sorularını yükle
  function loadRootQuestions() {
    const rootQuestionSelect = document.getElementById('rootQuestionSelect');
    const statusText = document.querySelector('#rootQuestionSection small');

    statusText.textContent = 'Yükleniyor...';
    statusText.className = 'text-muted';

    // Başlangıç sorularını al (parent_question__isnull=True olan sorular)
    fetch(`/get-root-questions/?username={{ profile_user.username }}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // Dropdown'ı temizle (ilk option hariç)
        rootQuestionSelect.innerHTML = '<option value="">-- Başlangıç sorusu seçin (opsiyonel) --</option>';

        // Başlangıç sorularını ekle
        data.root_questions.forEach(question => {
          const option = document.createElement('option');
          option.value = question.id;
          option.textContent = question.question_text;
          rootQuestionSelect.appendChild(option);
        });

        statusText.textContent = `${data.root_questions.length} başlangıç sorusu bulundu.`;
        statusText.className = 'text-success';
      })
      .catch(error => {
        console.error('Başlangıç soruları yüklenirken hata:', error);
        statusText.textContent = 'Başlangıç soruları yüklenirken hata oluştu.';
        statusText.className = 'text-danger';
      });
  }

  // Başlangıç sorusu seçildiğinde entry'leri filtrele
  document.getElementById('rootQuestionSelect').addEventListener('change', function() {
    currentPage = 1;
    userEntries = [];
    loadUserEntries();
  });

	  // Pagination ile entry'leri yükle
	  function escapeHtml(value) {
	    return String(value)
	      .replace(/&/g, '&amp;')
	      .replace(/</g, '&lt;')
	      .replace(/>/g, '&gt;')
	      .replace(/"/g, '&quot;')
	      .replace(/'/g, '&#39;');
	  }

	  function loadUserEntries(append = false) {
	    const container = document.getElementById('entriesContainer');

    if (!append) {
      container.innerHTML = '<p class="text-muted">Yükleniyor...</p>';
    }

    const rootQuestionId = document.getElementById('rootQuestionSelect').value;
    let url = `/get-user-answers/?username={{ profile_user.username }}&page=${currentPage}&page_size=50&q=${encodeURIComponent(currentSearchTerm)}`;

    // Eğer başlangıç sorusu seçildiyse, parametreye ekle
    if (rootQuestionId) {
      url += `&root_question_id=${rootQuestionId}`;
    }

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Entry yükleme başarılı:', data);
        totalEntries = data.total;
        hasMore = data.has_more;

        const newEntries = data.answers.map(answer => ({
          id: answer.id,
          question: answer.question_text,
          preview: answer.answer_text,
          date: answer.created_at
        }));

        if (append) {
          userEntries = userEntries.concat(newEntries);
        } else {
          userEntries = newEntries;
        }

        if (userEntries.length === 0) {
          container.innerHTML = '<p class="text-muted">Entry bulunamadı.</p>';
          loadMoreButton.style.display = 'none';
          return;
        }

        renderEntries();

        // "Daha Fazla Yükle" butonunu göster/gizle
        if (hasMore) {
          loadMoreButton.style.display = 'inline-block';
        } else {
          loadMoreButton.style.display = 'none';
        }
      })
	      .catch(error => {
	        console.error('Entry yükleme hatası:', error);
	        container.innerHTML = `<p class="text-danger">Entry'ler yüklenirken hata oluştu: ${escapeHtml(error.message)}</p>`;
	      });
	  }

  // Entry'leri render et
  function renderEntries() {
    const container = document.getElementById('entriesContainer');

    // Entry'leri listele
    let html = '<div class="entry-selection-list" id="sortableEntries">';
	    userEntries.forEach((entry, index) => {
	      html += `
	        <div class="form-check entry-item mb-2 p-2" style="border: 1px solid #dee2e6; border-radius: 0.25rem; cursor: move;" data-entry-id="${entry.id}" draggable="true">
	          <div class="d-flex align-items-start">
	            <input class="form-check-input me-2 entry-checkbox" type="checkbox" value="${entry.id}" id="entry${entry.id}">
	            <label class="form-check-label flex-grow-1" for="entry${entry.id}" style="cursor: pointer;">
	              <strong>${escapeHtml(entry.question)}</strong><br>
	              <small class="text-muted">${escapeHtml(entry.date)} - ${escapeHtml(entry.preview)}</small>
	            </label>
	            <div class="drag-handle" style="padding: 0.25rem;">
	              <i class="bi bi-grip-vertical"></i>
	            </div>
	          </div>
	        </div>
	      `;
	    });
    html += '</div>';
    container.innerHTML = html;

    // Checkbox değişikliklerini dinle (modal içinde ara)
    const checkboxes = downloadModal.querySelectorAll('.entry-checkbox');
    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateSelectedCount);
    });

    // Drag and drop özelliğini etkinleştir
    initDragAndDrop();

    updateSelectedCount();
  }

  // Drag and drop özelliği
  function initDragAndDrop() {
    const items = downloadModal.querySelectorAll('.entry-item');
    let draggedElement = null;

    items.forEach(item => {
      item.addEventListener('dragstart', function(e) {
        draggedElement = this;
        this.style.opacity = '0.5';
      });

      item.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
      });

      item.addEventListener('dragover', function(e) {
        e.preventDefault();
        if (this !== draggedElement) {
          const rect = this.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          if (e.clientY < midpoint) {
            this.parentNode.insertBefore(draggedElement, this);
          } else {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
          }
        }
      });
    });
  }

  // Tümünü seç (modal içinde ara)
  document.getElementById('selectAllEntries').addEventListener('click', function() {
    downloadModal.querySelectorAll('.entry-checkbox').forEach(cb => cb.checked = true);
    updateSelectedCount();
  });

  // Hiçbirini seçme (modal içinde ara)
  document.getElementById('deselectAllEntries').addEventListener('click', function() {
    downloadModal.querySelectorAll('.entry-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
  });

  // Seçili sayıyı güncelle
  function updateSelectedCount() {
    const count = downloadModal.querySelectorAll('.entry-checkbox:checked').length;
    // Server-side arama yapıyoruz, görünen = yüklenen
    const visible = userEntries.length;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('visibleCount').textContent = visible;
  }

  // "Daha Fazla Yükle" butonu
  loadMoreButton.addEventListener('click', function() {
    currentPage++;
    loadUserEntries(true); // append = true
  });

  // Entry arama fonksiyonu (server-side)
  let entryDownloadSearchTimeout;
  document.getElementById('searchEntriesInput').addEventListener('input', function(e) {
    clearTimeout(entryDownloadSearchTimeout);
    currentSearchTerm = e.target.value.trim();

    entryDownloadSearchTimeout = setTimeout(() => {
      currentPage = 1;
      userEntries = [];
      loadUserEntries();
    }, 500); // 500ms debounce
  });

  // İndir butonu
  document.getElementById('downloadButton').addEventListener('click', function() {
    const format = downloadModal.querySelector('input[name="format"]:checked').value;
    const order = document.getElementById('orderSelect').value;
    const downloadAll = downloadAllCheckbox.checked;
    const rootQuestionId = document.getElementById('rootQuestionSelect').value;

    let entryIds = [];

    // Eğer "tümünü indir" veya "başlangıç sorusu" SEÇİLİ DEĞİLSE, seçili entry'leri kontrol et
    if (!downloadAll && !rootQuestionId) {
      const selectedCheckboxes = downloadModal.querySelectorAll('.entry-checkbox:checked');

      if (selectedCheckboxes.length === 0) {
        alert('Lütfen en az bir entry seçin, bir başlangıç sorusu seçin veya "Tüm entry\'lerimi indir" seçeneğini işaretleyin!');
        return;
      }

      // Seçili entry ID'lerini al (sıralamaya göre)
      if (order === 'custom') {
        // DOM sırasına göre (drag-drop sonrası)
        const allItems = downloadModal.querySelectorAll('.entry-item');
        allItems.forEach(item => {
          const checkbox = item.querySelector('.entry-checkbox');
          if (checkbox && checkbox.checked) {
            entryIds.push(checkbox.value);
          }
        });
      } else {
        // Hepsini al, backend'de sıralar
        selectedCheckboxes.forEach(cb => entryIds.push(cb.value));
      }
    } else if (!downloadAll && rootQuestionId) {
      // Başlangıç sorusu seçiliyse ama "tümünü indir" değilse
      // Kullanıcı yine de spesifik entry'ler seçebilir
      const selectedCheckboxes = downloadModal.querySelectorAll('.entry-checkbox:checked');
      if (selectedCheckboxes.length > 0) {
        // Seçili entry'ler varsa sadece onları indir
        if (order === 'custom') {
          const allItems = downloadModal.querySelectorAll('.entry-item');
          allItems.forEach(item => {
            const checkbox = item.querySelector('.entry-checkbox');
            if (checkbox && checkbox.checked) {
              entryIds.push(checkbox.value);
            }
          });
        } else {
          selectedCheckboxes.forEach(cb => entryIds.push(cb.value));
        }
      }
      // Seçili entry yoksa, rootQuestionId backend'de filtreleme yapacak
    }
    // Eğer "tümünü indir" seçiliyse, entry_ids BOŞ kalır (backend tümünü alır)

    // İndirme URL'ini oluştur
    const username = '{{ profile_user.username }}';
    let downloadUrl = '';

    switch(format) {
      case 'pdf':
        downloadUrl = `/profile/${username}/download_entries_pdf/`;
        break;
      case 'docx':
        downloadUrl = `/profile/${username}/download_entries_docx/`;
        break;
      case 'xlsx':
        downloadUrl = `/profile/${username}/download_entries_xlsx/`;
        break;
      case 'json':
        downloadUrl = `/profile/${username}/download_entries_json/`;
        break;
    }

    // POST ile indir (entry ID'leri ve sıralama bilgisi ile)
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = downloadUrl;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    // Sadece "tümünü indir" SEÇİLİ DEĞİLSE entry_ids gönder
    if (!downloadAll && entryIds.length > 0) {
      const idsInput = document.createElement('input');
      idsInput.type = 'hidden';
      idsInput.name = 'entry_ids';
      idsInput.value = entryIds.join(',');
      form.appendChild(idsInput);
    }

    const orderInput = document.createElement('input');
    orderInput.type = 'hidden';
    orderInput.name = 'order';
    orderInput.value = order;
    form.appendChild(orderInput);

    // Başlangıç sorusu seçildiyse, onu da gönder
    if (rootQuestionId) {
      const rootQuestionInput = document.createElement('input');
      rootQuestionInput.type = 'hidden';
      rootQuestionInput.name = 'root_question_id';
      rootQuestionInput.value = rootQuestionId;
      form.appendChild(rootQuestionInput);
    }

    document.body.appendChild(form);
    form.submit();

    // Modal'ı kapat
    bootstrap.Modal.getInstance(downloadModal).hide();
  });
</script>
{% endblock extra_js %}
