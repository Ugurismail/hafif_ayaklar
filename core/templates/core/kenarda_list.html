{% extends "core/base.html" %}
{% block title %}Kenardakiler{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-hourglass-split"></i> Taslaklarım</h2>
    {% if taslaklar %}
      <span class="badge bg-primary rounded-pill">{{ taslaklar|length }} Taslak</span>
    {% endif %}
  </div>

  {% if taslaklar %}
    <div class="row g-4">
      {% for t in taslaklar %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card kenarda-card h-100 border-0 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start mb-3">
                <div class="flex-grow-1">
                  <h6 class="card-title mb-2">
                    {% if t.answer %}
                      <a href="{% url 'question_detail' t.answer.question.slug %}#answer-{{ t.answer.id }}" class="text-decoration-none text-dark">
                        <i class="bi bi-file-earmark-text text-warning me-1"></i>
                        <span class="badge bg-warning text-dark me-1">Düzenleme</span>
                        {{ t.answer.question.question_text|truncatechars:40 }}
                      </a>
                    {% elif t.question %}
                      <a href="{% url 'question_detail' t.question.slug %}" class="text-decoration-none text-dark">
                        <i class="bi bi-chat-square-text-fill text-primary me-1"></i>
                        {{ t.question.question_text|truncatechars:50 }}
                      </a>
                    {% else %}
                      {% if t.title %}
                        <span class="fw-bold">
                          <i class="bi bi-pencil-square me-1"></i>
                          {{ t.title|truncatechars:50 }}
                        </span>
                      {% else %}
                        <span class="text-muted">
                          <i class="bi bi-question-circle me-1"></i>
                          Bağlı soru yok
                        </span>
                      {% endif %}
                    {% endif %}
                  </h6>
                  <small class="text-muted">
                    <i class="bi bi-clock"></i> {{ t.updated_at|date:"d.m.Y H:i" }}
                  </small>
                </div>
              </div>

              <p class="card-text text-muted mb-3 flex-grow-1" style="font-size: 0.9rem;">
                {{ t.content|truncatechars:120 }}
              </p>

              <div class="d-flex gap-2 mt-auto">
                  <button class="btn btn-sm btn-theme-primary yukle-btn flex-fill"
                          data-taslak-id="{{ t.id }}"
                          data-taslak-content="{{ t.content|escapejs }}"
                          data-question-slug="{% if t.question %}{{ t.question.slug }}{% endif %}"
                          data-answer-id="{% if t.answer %}{{ t.answer.id }}{% endif %}"
                          data-draft-source="{{ t.draft_source }}"
                          data-taslak-title="{{ t.title|escapejs }}"
                          title="Yeniden düzenle">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                {% if t.question %}
                  <button class="btn btn-sm btn-theme-third gonder-btn flex-fill"
                          data-taslak-id="{{ t.id }}"
                          data-question-slug="{{ t.question.slug }}"
                          data-taslak-content="{{ t.content|escapejs }}"
                          title="Doğrudan gönder">
                    <i class="bi bi-send-fill"></i>
                  </button>
                {% endif %}
                <button class="btn btn-sm btn-theme-secondary sil-btn"
                        data-taslak-id="{{ t.id }}"
                        title="Sil">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
      </div>
      <h4 class="text-muted">Henüz taslak oluşturmadınız</h4>
      <p class="text-muted">Yanıt yazarken "Kenarda Beklet" butonunu kullanarak taslak oluşturabilirsiniz.</p>
    </div>
  {% endif %}
</div>

<!-- Silme Onay Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">
          <i class="bi bi-exclamation-triangle text-theme-warning"></i> Taslak Sil
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Bu taslağı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-theme-primary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-theme-secondary" id="confirmDeleteBtn">
          <i class="bi bi-trash"></i> Sil
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Gönder Onay Modal -->
<div class="modal fade" id="sendConfirmModal" tabindex="-1" aria-labelledby="sendConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sendConfirmModalLabel">
          <i class="bi bi-send text-theme-success"></i> Yanıtı Gönder
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Taslak içeriğiyle yanıtı göndermek istediğinizden emin misiniz?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-theme-primary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-theme-third" id="confirmSendBtn">
          <i class="bi bi-send"></i> Gönder
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="successToast" class="toast align-items-center toast-theme-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-check-circle me-2"></i>
        <span id="successToastMessage"></span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>

  <div id="errorToast" class="toast align-items-center toast-theme-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-x-circle me-2"></i>
        <span id="errorToastMessage"></span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<style>
.kenarda-card {
  transition: all 0.3s ease;
  border-radius: 0.75rem;
  border-left: 4px solid transparent;
}

.kenarda-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-4px);
  border-left-color: #0d6efd;
}

.kenarda-card .card-body {
  padding: 1.25rem;
}

.kenarda-card .card-title a:hover {
  color: #0d6efd !important;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentTaslakId = null;

  // Toast gösterme fonksiyonu
  function showToast(type, message) {
    const toastEl = document.getElementById(type + 'Toast');
    const messageEl = document.getElementById(type + 'ToastMessage');
    messageEl.textContent = message;
    const toast = new bootstrap.Toast(toastEl, {
      autohide: true,
      delay: 3000
    });
    toast.show();
  }

  // Yeniden Düzenle
  document.querySelectorAll('.yukle-btn').forEach(function(btn) {
    btn.onclick = function() {
      var taslakId = btn.getAttribute('data-taslak-id');
      var questionSlug = btn.getAttribute('data-question-slug');
      var answerId = btn.getAttribute('data-answer-id');
      var draftSource = btn.getAttribute('data-draft-source');
      var taslakTitle = btn.getAttribute('data-taslak-title');

      if (answerId) {
        // Answer düzenleme taslağıysa, edit_answer sayfasına git
        window.location.href = "/answer/" + answerId + "/edit/?draft_id=" + taslakId;
        return;
      }

      if (!questionSlug) {
        // Yanıt düzenleme olarak işaretlenmiş ama yanıt/soru bağlamı yoksa yanlış sayfaya düşmesin
        if (draftSource === 'answer_edit') {
          showToast('error', 'Bu taslak bir yanıta bağlı değil (bağlam kayıp).');
          return;
        }
        // Question yoksa, draft_source'a göre yönlendir
        if (draftSource === 'question_from_search' && taslakTitle) {
          // Aramadan soru oluşturma sayfasına yönlendir
          window.location.href = "{% url 'add_question_from_search' %}?q=" + encodeURIComponent(taslakTitle) + "&draft_id=" + taslakId;
        } else {
          // Başlangıç sorusu sayfasına yönlendir (varsayılan)
          window.location.href = "{% url 'add_starting_question' %}?draft_id=" + taslakId;
        }
        return;
      }
      // Question varsa, o soruya git
      window.location.href = "/" + questionSlug + "/?draft_id=" + taslakId;
    }
  });

  // Sil - Modal aç
  document.querySelectorAll('.sil-btn').forEach(function(btn) {
    btn.onclick = function() {
      currentTaslakId = btn.getAttribute('data-taslak-id');
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      deleteModal.show();
    }
  });

  // Silme onayı
  document.getElementById('confirmDeleteBtn').onclick = function() {
    if (!currentTaslakId) return;

    fetch("/kenarda/sil/" + currentTaslakId + "/", {
      method: "POST",
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
    })
    .then(r => r.json()).then(data => {
      const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
      deleteModal.hide();

      if(data.status == "ok") {
        showToast('success', 'Taslak başarıyla silindi!');
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast('error', 'Taslak silinemedi!');
      }
    })
    .catch(err => {
      const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
      deleteModal.hide();
      showToast('error', 'Bir hata oluştu!');
    });
  };

  // Doğrudan Gönder - Modal aç
  document.querySelectorAll('.gonder-btn').forEach(function(btn) {
    btn.onclick = function() {
      currentTaslakId = btn.getAttribute('data-taslak-id');
      const sendModal = new bootstrap.Modal(document.getElementById('sendConfirmModal'));
      sendModal.show();
    }
  });

  // Gönderme onayı
  document.getElementById('confirmSendBtn').onclick = function() {
    if (!currentTaslakId) return;

    fetch("/kenarda/gonder/" + currentTaslakId + "/", {
      method: "POST",
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
    })
    .then(r => r.json()).then(data => {
      const sendModal = bootstrap.Modal.getInstance(document.getElementById('sendConfirmModal'));
      sendModal.hide();

      if(data.status == "ok") {
        showToast('success', 'Yanıt başarıyla gönderildi!');
        // Yanıtın olduğu sayfaya yönlendir
        setTimeout(() => {
          window.location.href = "/" + data.question_slug + "/#answer-" + data.answer_id;
        }, 1000);
      } else {
        showToast('error', 'Yanıt gönderilemedi!');
      }
    })
    .catch(err => {
      const sendModal = bootstrap.Modal.getInstance(document.getElementById('sendConfirmModal'));
      sendModal.hide();
      showToast('error', 'Bir hata oluştu!');
    });
  };
});
</script>
{% endblock %}
